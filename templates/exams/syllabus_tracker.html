{% extends 'base/base.html' %}
{% load static %}

{% block title %}Syllabus Tracker{% endblock %}

{% block extra_css %}
<style>
    .syllabus-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .header-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px;
        border-radius: 12px;
        color: white;
        margin-bottom: 30px;
    }

    .exam-selector-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
    }

    .exam-selector {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
    }

    .exam-selector:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .load-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .load-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .load-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .statistics-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 15px;
    }

    .stat-item {
        text-align: center;
        padding: 15px;
        background: #f7fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .stat-value {
        font-size: 28px;
        font-weight: bold;
        color: #2d3748;
    }

    .stat-label {
        font-size: 14px;
        color: #718096;
        margin-top: 5px;
    }

    .progress-bar-container {
        background: #e2e8f0;
        height: 12px;
        border-radius: 6px;
        overflow: hidden;
        margin: 20px 0;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
        transition: width 0.5s ease;
    }

    .syllabus-tree {
        background: white;
        border-radius: 12px;
        padding: 25px;
        min-height: 400px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .tree-node {
        margin: 5px 0;
        position: relative;
    }

    .tree-node-content {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }

    .tree-node-content:hover {
        background: #f7fafc;
        border-color: #e2e8f0;
    }

    .tree-node-content.selected {
        background: #edf2ff;
        border-color: #667eea;
    }

    .node-expand-icon {
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        transition: transform 0.2s ease;
    }

    .node-expand-icon.expanded {
        transform: rotate(90deg);
    }

    .node-status-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .status-not-started {
        background: #e2e8f0;
        border: 2px solid #cbd5e0;
    }

    .status-in-progress {
        background: #fef3c7;
        border: 2px solid #fbbf24;
    }

    .status-completed {
        background: #d1fae5;
        border: 2px solid #10b981;
    }

    .status-revision {
        background: #ddd6fe;
        border: 2px solid #8b5cf6;
    }

    .node-title {
        flex: 1;
        font-weight: 500;
        color: #2d3748;
    }

    .node-badges {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .node-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-difficulty-easy {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-difficulty-medium {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-difficulty-hard {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-difficulty-expert {
        background: #f3e8ff;
        color: #6b21a8;
    }

    .badge-optional {
        background: #e0e7ff;
        color: #3730a3;
    }

    .badge-test-ready {
        background: #10b981;
        color: white;
    }

    .node-progress {
        font-size: 14px;
        color: #4a5568;
        margin-left: 8px;
    }

    .tree-children {
        margin-left: 35px;
        border-left: 2px solid #e2e8f0;
        padding-left: 15px;
        display: none;
    }

    .tree-children.expanded {
        display: block;
    }

    .depth-0 { margin-left: 0; }
    .depth-1 { margin-left: 25px; }
    .depth-2 { margin-left: 50px; }
    .depth-3 { margin-left: 75px; }
    .depth-4 { margin-left: 100px; }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #718096;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.3;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f4f6;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="syllabus-container">
    <!-- Header Section -->
    <div class="header-section">
        <h1 style="margin: 0; font-size: 32px; font-weight: 700;">
            📚 Syllabus Tracker
        </h1>
        <p style="margin-top: 10px; opacity: 0.95; font-size: 18px;">
            Track your exam preparation progress systematically
        </p>
    </div>

    <!-- Exam Selector Card -->
    <div class="exam-selector-card">
        <h3 style="margin-top: 0; color: #2d3748;">Select Exam</h3>
        <div style="display: flex; gap: 15px; align-items: center; margin-top: 15px;">
            <select id="examSelector" class="exam-selector">
                <option value="">-- Select an Exam --</option>
                {% for exam in exams %}
                <option value="{{ exam.id }}">{{ exam.name }}</option>
                {% endfor %}
            </select>
            <button id="loadSyllabusBtn" class="load-btn" onclick="loadSyllabus()">
                Load Syllabus
            </button>
        </div>
    </div>

    <!-- Statistics Card (Hidden initially) -->
    <div id="statisticsCard" class="statistics-card" style="display: none;">
        <h3 style="margin-top: 0; color: #2d3748;">Progress Overview</h3>
        <div class="progress-bar-container">
            <div id="overallProgressBar" class="progress-bar-fill" style="width: 0%;"></div>
        </div>
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-value" id="totalTopics">0</div>
                <div class="stat-label">Total Topics</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="completedTopics" style="color: #10b981;">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="inProgressTopics" style="color: #fbbf24;">0</div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="notStartedTopics" style="color: #94a3b8;">0</div>
                <div class="stat-label">Not Started</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="overallPercentage" style="color: #667eea;">0%</div>
                <div class="stat-label">Overall Progress</div>
            </div>
        </div>
    </div>

    <!-- Syllabus Tree -->
    <div id="syllabusTree" class="syllabus-tree">
        <div class="empty-state">
            <div class="empty-state-icon">📖</div>
            <h3>No Syllabus Loaded</h3>
            <p>Select an exam and click "Load Syllabus" to view the syllabus breakdown</p>
        </div>
    </div>
</div>

<script>
let currentSyllabusData = null;

function loadSyllabus() {
    const examSelector = document.getElementById('examSelector');
    const examId = examSelector.value;
    
    if (!examId) {
        alert('Please select an exam first');
        return;
    }
    
    const loadBtn = document.getElementById('loadSyllabusBtn');
    loadBtn.disabled = true;
    loadBtn.innerHTML = 'Loading... <span class="loading-spinner"></span>';
    
    fetch(`/exams/api/exam/${examId}/syllabus/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentSyllabusData = data;
                displayStatistics(data.statistics);
                displaySyllabusTree(data.syllabus.tree);
                document.getElementById('statisticsCard').style.display = 'block';
            } else {
                alert(data.error || 'Failed to load syllabus');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load syllabus. Please try again.');
        })
        .finally(() => {
            loadBtn.disabled = false;
            loadBtn.innerHTML = 'Load Syllabus';
        });
}

function displayStatistics(stats) {
    document.getElementById('totalTopics').textContent = stats.total_topics;
    document.getElementById('completedTopics').textContent = stats.completed_topics;
    document.getElementById('inProgressTopics').textContent = stats.in_progress_topics;
    document.getElementById('notStartedTopics').textContent = stats.not_started_topics;
    document.getElementById('overallPercentage').textContent = stats.overall_progress + '%';
    document.getElementById('overallProgressBar').style.width = stats.overall_progress + '%';
}

function displaySyllabusTree(tree) {
    const treeContainer = document.getElementById('syllabusTree');
    
    if (!tree || tree.length === 0) {
        treeContainer.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📝</div>
                <h3>No Syllabus Content</h3>
                <p>This exam doesn't have a syllabus defined yet.</p>
            </div>
        `;
        return;
    }
    
    treeContainer.innerHTML = renderTreeNodes(tree, 0);
}

function renderTreeNodes(nodes, depth) {
    let html = '';
    
    nodes.forEach(node => {
        const hasChildren = node.children && node.children.length > 0;
        const statusClass = `status-${node.progress.status.replace('_', '-')}`;
        const difficultyClass = `badge-difficulty-${node.difficulty}`;
        
        html += `
            <div class="tree-node depth-${depth}" data-node-id="${node.id}">
                <div class="tree-node-content" onclick="${hasChildren ? `toggleNode('${node.id}')` : `openLearningPage('${node.id}', '${node.title}')`}">
                    ${hasChildren ? `
                        <span class="node-expand-icon" id="expand-${node.id}">▶</span>
                    ` : '<span style="width: 30px; display: inline-block;"></span>'}
                    
                    <div class="node-status-icon ${statusClass}"></div>
                    
                    <div class="node-title">${node.title}</div>
                    
                    <div class="node-badges">
                        <span class="node-badge ${difficultyClass}">${node.difficulty}</span>
                        ${node.is_optional ? '<span class="node-badge badge-optional">Optional</span>' : ''}
                        ${node.progress.test_ready ? '<span class="node-badge badge-test-ready">Test Ready</span>' : ''}
                        ${node.weightage > 0 ? `<span class="node-badge" style="background: #f0f4f8; color: #4a5568;">${node.weightage}%</span>` : ''}
                    </div>
                    
                    <span class="node-progress">${node.progress.percentage}%</span>
                </div>
                
                ${hasChildren ? `
                    <div class="tree-children" id="children-${node.id}">
                        ${renderTreeNodes(node.children, depth + 1)}
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    return html;
}

function toggleNode(nodeId) {
    const expandIcon = document.getElementById(`expand-${nodeId}`);
    const childrenContainer = document.getElementById(`children-${nodeId}`);
    
    if (expandIcon && childrenContainer) {
        expandIcon.classList.toggle('expanded');
        childrenContainer.classList.toggle('expanded');
    }
}

function openLearningPage(nodeId, nodeTitle) {
    // Open learning page in new tab for focused learning
    const learningUrl = `/exams/learn/${nodeId}/`;
    window.open(learningUrl, '_blank', 'width=1400,height=900');
}

// Auto-load if exam_id is in URL params
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const examId = urlParams.get('exam_id');
    
    if (examId) {
        document.getElementById('examSelector').value = examId;
        loadSyllabus();
    }
});
</script>
{% endblock %}