{% extends 'base/base.html' %}
{% load static %}

{% block title %}My PDF Documents{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <nav class="flex" aria-label="Breadcrumb">
                        <ol class="flex items-center space-x-4">
                            <li>
                                <a href="{% url 'pdf_extractor:home' %}" class="text-gray-400 hover:text-gray-500">
                                    <svg class="flex-shrink-0 h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                                    </svg>
                                </a>
                            </li>
                            <li>
                                <div class="flex items-center">
                                    <svg class="flex-shrink-0 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="ml-4 text-sm text-gray-500">Documents</span>
                                </div>
                            </li>
                        </ol>
                    </nav>
                    <h1 class="mt-2 text-2xl font-bold text-gray-900">
                        {% if user.is_superuser %}All PDF Documents{% else %}My PDF Documents{% endif %}
                    </h1>
                    <p class="text-gray-600">
                        {% if user.is_superuser %}
                            Manage and review all uploaded PDF documents across all users
                        {% else %}
                            Manage and review your uploaded PDF documents
                        {% endif %}
                    </p>
                </div>
                <div class="flex space-x-3">
                    <a href="{% url 'pdf_extractor:home' %}" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Upload New PDF
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Enhanced Search and Filter Bar -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
            <!-- Gradient Header -->
            <div class="bg-gradient-to-r from-blue-600 via-blue-700 to-indigo-700 rounded-t-lg p-4 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="bg-white/20 rounded-lg p-2 mr-3">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold">Advanced Search & Filters</h3>
                            <p class="text-blue-100 text-sm">Find documents by metadata, content, and properties</p>
                        </div>
                    </div>
                    <button type="button" id="toggle-advanced-filters" class="bg-white/10 hover:bg-white/20 rounded-full px-3 py-1 text-xs font-medium transition-colors">
                        <span id="toggle-text">Show Advanced</span>
                        <svg id="toggle-icon" class="w-3 h-3 ml-1 inline transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <form method="GET" class="space-y-6">
                    <!-- Primary search row -->
                    <div class="flex flex-col lg:flex-row gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Search Documents</label>
                            <input type="text" name="search" value="{{ search_query }}" 
                                   placeholder="Search by title, filename, description, tags, organization..." 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white transition-colors">
                        </div>
                        <div class="lg:w-48">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select name="status" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white">
                                <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Status</option>
                                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="processing" {% if status_filter == 'processing' %}selected{% endif %}>Processing</option>
                                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                                <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>Failed</option>
                            </select>
                        </div>
                        {% if user.is_superuser %}
                        <div class="lg:w-48">
                            <label class="block text-sm font-medium text-gray-700 mb-2">User</label>
                            <input type="text" name="user" value="{{ user_filter }}" 
                                   placeholder="Filter by username..." 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white">
                        </div>
                        {% endif %}
                        <div class="flex items-end gap-2">
                            <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 transition-colors font-medium">
                                <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                Search
                            </button>
                            <button type="button" onclick="clearAllFilters()" class="px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Clear
                            </button>
                        </div>
                    </div>
                    
                    <!-- Advanced filters section (collapsible) -->
                    <div id="advanced-filters" class="space-y-6 pt-6 border-t border-gray-200" style="display: none;">
                        <!-- Filter Categories Row 1: Exam & Organization -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Exam Type</label>
                                <select name="exam_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white">
                                    <option value="">All Exam Types</option>
                                    {% for value, display in exam_type_choices %}
                                        <option value="{{ value }}" {% if exam_type_filter == value %}selected{% endif %}>{{ display }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Organization</label>
                                <input type="text" name="organization" value="{{ organization_filter }}" 
                                       placeholder="e.g., UPSC, SSC, IBPS..." 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
                                <input type="text" name="subject" value="{{ subject_filter }}" 
                                       placeholder="e.g., Mathematics, History..." 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Year</label>
                                <input type="number" name="year" value="{{ year_filter }}" 
                                       placeholder="2024" min="1990" max="2030"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white">
                            </div>
                        </div>
                        
                        <!-- Filter Categories Row 2: Source & Tags -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Source Type</label>
                                <select name="source_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white">
                                    <option value="">All Source Types</option>
                                    {% for value, display in source_type_choices %}
                                        <option value="{{ value }}" {% if source_type_filter == value %}selected{% endif %}>{{ display }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
                                <input type="text" name="tags" value="{{ tags_filter }}" 
                                       placeholder="tag1, tag2, tag3..." 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white">
                                <p class="text-xs text-gray-500 mt-1">Separate multiple tags with commas</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">File Size</label>
                                <select name="size_range" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white">
                                    <option value="">Any Size</option>
                                    <option value="small" {% if size_filter == 'small' %}selected{% endif %}>Small (&lt; 5MB)</option>
                                    <option value="medium" {% if size_filter == 'medium' %}selected{% endif %}>Medium (5-20MB)</option>
                                    <option value="large" {% if size_filter == 'large' %}selected{% endif %}>Large (&gt; 20MB)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Filter Categories Row 3: Date Range & Sort -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Date From</label>
                                <input type="date" name="date_from" value="{{ date_from }}" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Date To</label>
                                <input type="date" name="date_to" value="{{ date_to }}" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                                <select name="sort_by" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white">
                                    <option value="-uploaded_at" {% if sort_by == '-uploaded_at' %}selected{% endif %}>Newest First</option>
                                    <option value="uploaded_at" {% if sort_by == 'uploaded_at' %}selected{% endif %}>Oldest First</option>
                                    <option value="filename" {% if sort_by == 'filename' %}selected{% endif %}>Filename A-Z</option>
                                    <option value="-filename" {% if sort_by == '-filename' %}selected{% endif %}>Filename Z-A</option>
                                    <option value="title" {% if sort_by == 'title' %}selected{% endif %}>Title A-Z</option>
                                    <option value="-title" {% if sort_by == '-title' %}selected{% endif %}>Title Z-A</option>
                                    <option value="-year" {% if sort_by == '-year' %}selected{% endif %}>Year (Latest)</option>
                                    <option value="year" {% if sort_by == 'year' %}selected{% endif %}>Year (Earliest)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Active Filters Display -->
                    <div id="active-filters" class="flex flex-wrap gap-2" style="display: none;">
                        <!-- Active filters will be populated by JavaScript -->
                    </div>
                </form>
            </div>
        </div>

        <!-- Documents List -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900">Documents</h2>
                    
                    <!-- Bulk Actions -->
                    <div class="flex items-center space-x-3">
                        <div id="bulk-actions" class="hidden flex items-center space-x-2">
                            <span id="selected-count" class="text-sm text-gray-600">0 selected</span>
                            <button id="bulk-edit-metadata" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Bulk Edit
                            </button>
                            <button id="bulk-export" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export
                            </button>
                        </div>
                        
                        <button id="select-all" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Select All
                        </button>
                        
                        <button id="apply-template" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                            Apply Template
                        </button>
                    </div>
                </div>
            </div>
            
            {% if documents %}
                <div class="divide-y divide-gray-200">
                    {% for document in documents %}
                        <div class="p-6 hover:bg-gray-50 document-row" data-document-id="{{ document.id }}">
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center">
                                        <!-- Selection Checkbox -->
                                        <div class="flex-shrink-0 mr-4">
                                            <input type="checkbox" class="document-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" data-document-id="{{ document.id }}">
                                        </div>
                                        <div class="flex-shrink-0">
                                            <svg class="h-8 w-8 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                        <div class="ml-4">
                                            <div class="flex items-center">
                                                <h3 class="text-sm font-medium text-gray-900 truncate">
                                                    {{ document.title|default:document.filename }}
                                                    {% if document.title and document.title != document.filename %}
                                                        <span class="text-xs text-gray-500 ml-1">({{ document.filename }})</span>
                                                    {% endif %}
                                                </h3>
                                                <!-- Real Processing Status -->
                                                {% if document.processing_status.color == 'green' %}
                                                    <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                        </svg>
                                                        {{ document.processing_status.display }}
                                                    </span>
                                                {% elif document.processing_status.color == 'orange' %}
                                                    <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                                        </svg>
                                                        {{ document.processing_status.display }}
                                                    </span>
                                                {% elif document.processing_status.color == 'blue' %}
                                                    <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                        <svg class="animate-spin w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24">
                                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                        </svg>
                                                        {{ document.processing_status.display }}
                                                    </span>
                                                {% elif document.processing_status.color == 'yellow' %}
                                                    <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                                        </svg>
                                                        {{ document.processing_status.display }}
                                                    </span>
                                                {% else %}
                                                    <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                                        </svg>
                                                        {{ document.processing_status.display }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <div class="mt-1 flex items-center text-sm text-gray-500">
                                                <p>Uploaded {{ document.uploaded_at|timesince }} ago</p>
                                                {% if user.is_superuser and document.uploaded_by %}
                                                    <span class="mx-1">•</span>
                                                    <p class="font-medium text-indigo-600">by {{ document.uploaded_by.username }}</p>
                                                {% endif %}
                                                {% if document.file_size %}
                                                    <span class="mx-1">•</span>
                                                    <p>{{ document.file_size|filesizeformat }}</p>
                                                {% endif %}
                                                {% if document.page_count %}
                                                    <span class="mx-1">•</span>
                                                    <p>{{ document.page_count }} page{{ document.page_count|pluralize }}</p>
                                                {% endif %}
                                                {% if document.year %}
                                                    <span class="mx-1">•</span>
                                                    <p>{{ document.year }}</p>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Document Metadata -->
                                            {% if document.description or document.exam_type or document.organization or document.subject or document.tags %}
                                                <div class="mt-2 space-y-1">
                                                    {% if document.description %}
                                                        <p class="text-sm text-gray-600">{{ document.description|truncatewords:15 }}</p>
                                                    {% endif %}
                                                    
                                                    <div class="flex flex-wrap items-center gap-2 text-xs">
                                                        {% if document.exam_type %}
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full bg-blue-100 text-blue-800">
                                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                                </svg>
                                                                {{ document.get_exam_type_display }}
                                                            </span>
                                                        {% endif %}
                                                        
                                                        {% if document.organization %}
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full bg-purple-100 text-purple-800">
                                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                                                </svg>
                                                                {{ document.organization|truncatewords:3 }}
                                                            </span>
                                                        {% endif %}
                                                        
                                                        {% if document.subject %}
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full bg-green-100 text-green-800">
                                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                                                </svg>
                                                                {{ document.subject|truncatewords:2 }}
                                                            </span>
                                                        {% endif %}
                                                        
                                                        {% if document.source_type %}
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full bg-yellow-100 text-yellow-800">
                                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a.997.997 0 01-1.414 0l-7-7A1.994 1.994 0 013 10V5a2 2 0 012-2z"></path>
                                                                </svg>
                                                                {% if document.source_type == 'previous_year' %}Previous Year
                                                                {% elif document.source_type == 'mock_test' %}Mock Test
                                                                {% elif document.source_type == 'study_material' %}Study Material
                                                                {% elif document.source_type == 'practice_set' %}Practice Set
                                                                {% elif document.source_type == 'sample_paper' %}Sample Paper
                                                                {% elif document.source_type == 'question_bank' %}Question Bank
                                                                {% else %}{{ document.source_type|capfirst }}
                                                                {% endif %}
                                                            </span>
                                                        {% endif %}
                                                        
                                                        {% if document.tags %}
                                                            {% for tag in document.tags|slice:":3" %}
                                                                <span class="inline-flex items-center px-2 py-1 rounded-full bg-gray-100 text-gray-700">
                                                                    #{{ tag }}
                                                                </span>
                                                            {% endfor %}
                                                            {% if document.tags|length > 3 %}
                                                                <span class="text-gray-500">+{{ document.tags|length|add:"-3" }} more</span>
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% endif %}
                                            <!-- Processing Status Description -->
                                            {% if document.processing_status.description %}
                                                <div class="mt-2 text-sm text-gray-600">
                                                    {{ document.processing_status.description }}
                                                </div>
                                            {% endif %}
                                            {% if document.extraction_notes %}
                                                <div class="mt-2 text-sm text-gray-600">
                                                    {{ document.extraction_notes|truncatewords:20 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    {% if document.status == 'completed' %}
                                        <!-- Interactive Review Button -->
                                        <a href="{% url 'pdf_extractor:interactive_review' document.id %}" 
                                           class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-white bg-green-600 hover:bg-green-700">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                            Review
                                        </a>
                                        
                                        <a href="{% url 'pdf_extractor:document_detail' document.id %}" 
                                           class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                                            View Details
                                        </a>
                                    {% elif document.status == 'processing' %}
                                        <a href="{% url 'pdf_extractor:document_detail' document.id %}" 
                                           class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                                            View Progress
                                        </a>
                                    {% else %}
                                        <a href="{% url 'pdf_extractor:document_detail' document.id %}" 
                                           class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                                            View Details
                                        </a>
                                    {% endif %}
                                    
                                    <!-- Delete Button -->
                                    <button onclick="confirmDeleteDocument('{{ document.id }}', '{{ document.title|default:document.filename|escapejs }}')"
                                            class="inline-flex items-center px-3 py-1.5 border border-red-300 text-xs font-medium rounded text-red-700 bg-white hover:bg-red-50">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if documents.has_other_pages %}
                    <nav class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                        <div class="hidden sm:block">
                            <p class="text-sm text-gray-700">
                                Showing
                                <span class="font-medium">{{ documents.start_index }}</span>
                                to
                                <span class="font-medium">{{ documents.end_index }}</span>
                                of
                                <span class="font-medium">{{ documents.paginator.count }}</span>
                                results
                            </p>
                        </div>
                        <div class="flex-1 flex justify-between sm:justify-end">
                            {% if documents.has_previous %}
                                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if status_filter != 'all' %}status={{ status_filter }}&{% endif %}page={{ documents.previous_page_number }}" 
                                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    Previous
                                </a>
                            {% endif %}
                            {% if documents.has_next %}
                                <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if status_filter != 'all' %}status={{ status_filter }}&{% endif %}page={{ documents.next_page_number }}" 
                                   class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    Next
                                </a>
                            {% endif %}
                        </div>
                    </nav>
                {% endif %}
            {% else %}
                <div class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No documents found</h3>
                    <p class="mt-1 text-sm text-gray-500">
                        {% if search_query or status_filter != 'all' %}
                            Try adjusting your search or filter criteria.
                        {% else %}
                            Get started by uploading your first PDF document.
                        {% endif %}
                    </p>
                    <div class="mt-6">
                        {% if search_query or status_filter != 'all' %}
                            <a href="{% url 'pdf_extractor:document_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                Clear Filters
                            </a>
                        {% else %}
                            <a href="{% url 'pdf_extractor:home' %}" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Upload PDF
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mt-2">Delete Document</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">
                    Are you sure you want to delete "<span id="documentNameToDelete" class="font-semibold"></span>"?
                </p>
                <div class="mt-4 p-4 bg-red-50 rounded-md">
                    <div class="text-sm text-red-800">
                        <p class="font-semibold">⚠️ Warning: This action cannot be undone!</p>
                        <ul class="mt-2 list-disc list-inside space-y-1">
                            <li>The PDF file will be permanently deleted</li>
                            <li>All extracted questions will be removed</li>
                            <li>All saved regions and annotations will be lost</li>
                            <li>Processing history will be deleted</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="flex gap-4 justify-center mt-4">
                <button id="cancelDelete" 
                        class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-24 hover:bg-gray-400">
                    Cancel
                </button>
                <button id="confirmDelete" 
                        class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-24 hover:bg-red-700">
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let documentToDelete = null;

function confirmDeleteDocument(documentId, documentName) {
    documentToDelete = documentId;
    document.getElementById('documentNameToDelete').textContent = documentName;
    document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    documentToDelete = null;
}

async function deleteDocument() {
    if (!documentToDelete) return;
    
    try {
        const response = await fetch(`/pdf-extractor/api/delete-document/${documentToDelete}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remove the document row from the page
            location.reload(); // Simple approach - reload the page
        } else {
            alert('Failed to delete document: ' + data.error);
        }
    } catch (error) {
        alert('Error deleting document: ' + error.message);
    } finally {
        closeDeleteModal();
    }
}

// Event listeners
document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);
document.getElementById('confirmDelete').addEventListener('click', deleteDocument);

// Close modal when clicking outside
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});

// Clear all filters
function clearAllFilters() {
    const form = document.querySelector('form');
    const inputs = form.querySelectorAll('input[type="text"], input[type="number"], input[type="date"]');
    const selects = form.querySelectorAll('select');
    
    inputs.forEach(input => {
        input.value = '';
    });
    
    selects.forEach(select => {
        if (select.name === 'status') {
            select.value = 'all';
        } else if (select.name === 'sort_by') {
            select.value = '-uploaded_at';
        } else {
            select.value = '';
        }
    });
    
    // Hide active filters
    document.getElementById('active-filters').style.display = 'none';
    
    // Submit the form to apply the cleared filters
    form.submit();
}

// Toggle advanced filters visibility
function toggleAdvancedFilters() {
    console.log('Toggle advanced filters clicked');
    const advancedFilters = document.getElementById('advanced-filters');
    const toggleText = document.getElementById('toggle-text');
    const toggleIcon = document.getElementById('toggle-icon');
    
    if (!advancedFilters || !toggleText || !toggleIcon) {
        console.error('Missing elements for toggle functionality');
        return;
    }
    
    if (advancedFilters.style.display === 'none' || !advancedFilters.style.display) {
        advancedFilters.style.display = 'block';
        toggleText.textContent = 'Hide Advanced';
        toggleIcon.style.transform = 'rotate(180deg)';
        console.log('Advanced filters shown');
    } else {
        advancedFilters.style.display = 'none';
        toggleText.textContent = 'Show Advanced';
        toggleIcon.style.transform = 'rotate(0deg)';
        console.log('Advanced filters hidden');
    }
}

// Show active filters
function showActiveFilters() {
    const params = new URLSearchParams(window.location.search);
    const activeFiltersDiv = document.getElementById('active-filters');
    const filterLabels = {
        'search': 'Search',
        'status': 'Status',
        'exam_type': 'Exam Type',
        'organization': 'Organization',
        'subject': 'Subject',
        'year': 'Year',
        'source_type': 'Source Type',
        'tags': 'Tags',
        'date_from': 'Date From',
        'date_to': 'Date To',
        'size_range': 'File Size',
        'sort_by': 'Sort By'
    };
    
    const skipDefaults = {
        'status': 'all',
        'sort_by': '-uploaded_at'
    };
    
    let hasActiveFilters = false;
    activeFiltersDiv.innerHTML = '';
    
    // Add "Active Filters:" label
    const labelSpan = document.createElement('span');
    labelSpan.className = 'text-sm font-medium text-gray-600 mr-2';
    labelSpan.textContent = 'Active Filters:';
    
    for (const [key, value] of params.entries()) {
        if (value && value.trim() !== '' && 
            (!skipDefaults[key] || skipDefaults[key] !== value) && 
            filterLabels[key]) {
            
            if (!hasActiveFilters) {
                activeFiltersDiv.appendChild(labelSpan);
                hasActiveFilters = true;
            }
            
            const filterTag = document.createElement('span');
            filterTag.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200';
            
            let displayValue = value;
            
            // Format display values
            if (key === 'size_range') {
                const sizeMap = {
                    'small': 'Small (< 5MB)',
                    'medium': 'Medium (5-20MB)', 
                    'large': 'Large (> 20MB)'
                };
                displayValue = sizeMap[value] || value;
            } else if (key === 'sort_by') {
                const sortMap = {
                    '-uploaded_at': 'Newest First',
                    'uploaded_at': 'Oldest First',
                    'filename': 'Filename A-Z',
                    '-filename': 'Filename Z-A',
                    'title': 'Title A-Z',
                    '-title': 'Title Z-A',
                    '-year': 'Year (Latest)',
                    'year': 'Year (Earliest)'
                };
                displayValue = sortMap[value] || value;
            }
            
            filterTag.innerHTML = `
                <span>${filterLabels[key]}: ${displayValue}</span>
                <button type="button" onclick="removeFilter('${key}')" class="ml-2 hover:text-blue-600">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            
            activeFiltersDiv.appendChild(filterTag);
        }
    }
    
    if (hasActiveFilters) {
        activeFiltersDiv.style.display = 'flex';
        
        // Add clear all button
        const clearAllBtn = document.createElement('button');
        clearAllBtn.type = 'button';
        clearAllBtn.className = 'inline-flex items-center px-3 py-1 text-xs font-medium text-gray-600 hover:text-gray-800 border border-gray-300 rounded-full hover:bg-gray-50 ml-2';
        clearAllBtn.innerHTML = `
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Clear All
        `;
        clearAllBtn.onclick = function() {
            window.location.href = window.location.pathname;
        };
        activeFiltersDiv.appendChild(clearAllBtn);
    } else {
        activeFiltersDiv.style.display = 'none';
    }
}

// Remove individual filter
function removeFilter(filterKey) {
    const params = new URLSearchParams(window.location.search);
    params.delete(filterKey);
    
    // Reset to defaults for certain fields
    if (filterKey === 'status') {
        params.set('status', 'all');
    } else if (filterKey === 'sort_by') {
        params.set('sort_by', '-uploaded_at');
    }
    
    const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    window.location.href = newUrl;
}

// Auto-show advanced filters if any advanced filters are active
function checkForAdvancedFilters() {
    const params = new URLSearchParams(window.location.search);
    const advancedFilterKeys = ['exam_type', 'organization', 'subject', 'year', 'source_type', 'tags', 'date_from', 'date_to', 'size_range'];
    
    for (const key of advancedFilterKeys) {
        if (params.get(key)) {
            toggleAdvancedFilters();
            break;
        }
    }
}

// Bulk Actions Functionality
let selectedDocuments = new Set();

function updateBulkActionsVisibility() {
    const bulkActionsDiv = document.getElementById('bulk-actions');
    const selectedCountSpan = document.getElementById('selected-count');
    const selectAllBtn = document.getElementById('select-all');
    
    if (selectedDocuments.size > 0) {
        bulkActionsDiv.classList.remove('hidden');
        bulkActionsDiv.classList.add('flex');
        selectedCountSpan.textContent = `${selectedDocuments.size} selected`;
        selectAllBtn.textContent = selectedDocuments.size === document.querySelectorAll('.document-checkbox').length ? 'Deselect All' : 'Select All';
    } else {
        bulkActionsDiv.classList.add('hidden');
        bulkActionsDiv.classList.remove('flex');
        selectAllBtn.textContent = 'Select All';
    }
}

function toggleDocumentSelection(documentId, isSelected) {
    if (isSelected) {
        selectedDocuments.add(documentId);
    } else {
        selectedDocuments.delete(documentId);
    }
    updateBulkActionsVisibility();
}

// Event listeners for bulk actions
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    
    try {
        // Initialize advanced search functionality
        showActiveFilters();
        checkForAdvancedFilters();
        
        // Add toggle event listener
        const toggleBtn = document.getElementById('toggle-advanced-filters');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', toggleAdvancedFilters);
            console.log('Toggle button event listener added');
        } else {
            console.error('Toggle advanced filters button not found');
        }
    
        // Handle individual checkbox changes
        document.querySelectorAll('.document-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                toggleDocumentSelection(this.dataset.documentId, this.checked);
            });
        });
        console.log('Document checkbox listeners added');
        
        // Handle select all button
        const selectAllBtn = document.getElementById('select-all');
        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.document-checkbox');
                const shouldSelectAll = selectedDocuments.size === 0 || selectedDocuments.size < checkboxes.length;
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = shouldSelectAll;
                    toggleDocumentSelection(checkbox.dataset.documentId, shouldSelectAll);
                });
            });
            console.log('Select all button listener added');
        }
    
        // Handle bulk edit metadata
        const bulkEditBtn = document.getElementById('bulk-edit-metadata');
        if (bulkEditBtn) {
            bulkEditBtn.addEventListener('click', function() {
                if (selectedDocuments.size === 0) return;
        
        const documentIds = Array.from(selectedDocuments);
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/pdf-extractor/bulk-edit-metadata/';
        
        // Add CSRF token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);
        
        // Add document IDs
        documentIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'document_ids';
            input.value = id;
            form.appendChild(input);
        });
        
                document.body.appendChild(form);
                form.submit();
            });
            console.log('Bulk edit metadata listener added');
        }
    
        // Handle bulk export
        const bulkExportBtn = document.getElementById('bulk-export');
        if (bulkExportBtn) {
            bulkExportBtn.addEventListener('click', function() {
                if (selectedDocuments.size === 0) return;
                
                const documentIds = Array.from(selectedDocuments);
                const params = new URLSearchParams();
                documentIds.forEach(id => params.append('document_ids', id));
                
                window.open(`/pdf-extractor/export-metadata/?${params.toString()}`, '_blank');
            });
            console.log('Bulk export listener added');
        }
    
        
        // Handle apply template
        const applyTemplateBtn = document.getElementById('apply-template');
        if (applyTemplateBtn) {
            applyTemplateBtn.addEventListener('click', function() {
                if (selectedDocuments.size === 0) {
                    alert('Please select documents first');
                    return;
                }
                
                // Show template selection modal
                showTemplateSelectionModal();
            });
            console.log('Apply template listener added');
        }
        
    } catch (error) {
        console.error('Error setting up event listeners:', error);
    }
});

// Template selection functionality
async function showTemplateSelectionModal() {
    try {
        // For now, redirect to templates page with selection info
        const documentIds = Array.from(selectedDocuments);
        sessionStorage.setItem('selectedDocumentIds', JSON.stringify(documentIds));
        sessionStorage.setItem('selectedDocumentCount', selectedDocuments.size);
        window.location.href = '/pdf-extractor/metadata-templates/';
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>

{% endblock %}