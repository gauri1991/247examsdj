{% extends 'base/base.html' %}

{% block title %}Admin Management - Exam Portal{% endblock %}

{% block extra_css %}
<style>
    [x-cloak] {
        display: none !important;
    }
    .admin-sidebar {
        transition: transform 0.3s ease;
        width: 16rem; /* Fixed width instead of relying on Tailwind */
        min-width: 16rem;
        max-width: 16rem;
    }
    .admin-content {
        transition: none; /* Remove transitions on content area */
        flex: 1;
        min-width: 0; /* Allow shrinking */
        overflow-x: auto; /* Handle horizontal overflow */
    }
    .sidebar-item {
        transition: all 0.2s ease;
    }
    .sidebar-item:hover {
        background-color: #f3f4f6;
        border-left: 3px solid #3b82f6;
    }
    .sidebar-item.active {
        background-color: #dbeafe;
        border-left: 3px solid #3b82f6;
        color: #1e40af;
    }
    .stat-card {
        transition: all 0.2s ease;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50" x-data="adminDashboard()">
    <!-- Mobile Menu Button Only -->
    <div class="lg:hidden bg-white shadow-sm border-b sticky top-0 z-30">
        <div class="px-4 py-2">
            <button @click="sidebarOpen = !sidebarOpen" class="p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
    </div>

    <div class="flex overflow-hidden">
        <!-- Sidebar -->
        <div class="admin-sidebar bg-white shadow-lg w-64 flex-shrink-0" 
             :class="{'hidden lg:block': !sidebarOpen && isMobile}"
             x-show="sidebarOpen || !isMobile"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="-translate-x-full"
             x-transition:enter-end="translate-x-0">
            
            <div class="p-4">
                <nav class="space-y-2">
                    <!-- Dashboard -->
                    <a href="#" @click="setActiveSection('dashboard')" 
                       class="sidebar-item flex items-center px-4 py-3 text-sm font-medium rounded-lg"
                       :class="activeSection === 'dashboard' ? 'active' : 'text-gray-700 hover:text-gray-900'">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v3H8V5z"></path>
                        </svg>
                        Dashboard
                    </a>

                    <!-- User Management -->
                    <a href="#" @click="setActiveSection('users')" 
                       class="sidebar-item flex items-center px-4 py-3 text-sm font-medium rounded-lg"
                       :class="activeSection === 'users' ? 'active' : 'text-gray-700 hover:text-gray-900'">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                        User Management
                    </a>

                    <!-- Exam Management -->
                    <a href="#" @click="setActiveSection('exams')" 
                       class="sidebar-item flex items-center px-4 py-3 text-sm font-medium rounded-lg"
                       :class="activeSection === 'exams' ? 'active' : 'text-gray-700 hover:text-gray-900'">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Exam Management
                    </a>

                    <!-- Question Banks -->
                    <a href="#" @click="setActiveSection('questions')" 
                       class="sidebar-item flex items-center px-4 py-3 text-sm font-medium rounded-lg"
                       :class="activeSection === 'questions' ? 'active' : 'text-gray-700 hover:text-gray-900'">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 11.685c.554-1.055 1.689-1.685 2.887-1.685 1.198 0 2.333.63 2.887 1.685m-5.774 0h5.774M12 19c-3.866 0-7-3.133-7-7 0-3.866 3.134-7 7-7s7 3.134 7 7c0 3.867-3.134 7-7 7z"></path>
                        </svg>
                        Question Banks
                    </a>

                    <!-- Documents -->
                    <a href="#" @click="setActiveSection('documents')" 
                       class="sidebar-item flex items-center px-4 py-3 text-sm font-medium rounded-lg"
                       :class="activeSection === 'documents' ? 'active' : 'text-gray-700 hover:text-gray-900'">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Documents
                    </a>

                    <!-- Subscription Management -->
                    <a href="#" @click="setActiveSection('subscriptions')" 
                       class="sidebar-item flex items-center px-4 py-3 text-sm font-medium rounded-lg"
                       :class="activeSection === 'subscriptions' ? 'active' : 'text-gray-700 hover:text-gray-900'">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                        Subscriptions
                    </a>

                    <!-- Payment Management -->
                    <a href="#" @click="setActiveSection('payments')" 
                       class="sidebar-item flex items-center px-4 py-3 text-sm font-medium rounded-lg"
                       :class="activeSection === 'payments' ? 'active' : 'text-gray-700 hover:text-gray-900'">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        Payments
                    </a>

                    <!-- Global Topic Taxonomy -->
                    <a href="#" @click="setActiveSection('taxonomy')" 
                       class="sidebar-item flex items-center px-4 py-3 text-sm font-medium rounded-lg"
                       :class="activeSection === 'taxonomy' ? 'active' : 'text-gray-700 hover:text-gray-900'">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14-7H5m14 14H5m14-7H5"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3l9 4.5-9 4.5L3 7.5 12 3z"/>
                        </svg>
                        Topic Taxonomy
                    </a>

                    <!-- System Settings -->
                    <a href="#" @click="setActiveSection('settings')" 
                       class="sidebar-item flex items-center px-4 py-3 text-sm font-medium rounded-lg"
                       :class="activeSection === 'settings' ? 'active' : 'text-gray-700 hover:text-gray-900'">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        System Settings
                    </a>

                    <!-- Django Admin -->
                    <a href="/admin/" target="_blank"
                       class="sidebar-item flex items-center px-4 py-3 text-sm font-medium rounded-lg text-gray-700 hover:text-gray-900">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        Django Admin
                        <svg class="w-4 h-4 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </a>
                </nav>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 admin-content min-w-0">
            <div class="p-6">
                
                <!-- Dashboard Section -->
                <div id="dashboard-section" x-show="activeSection === 'dashboard'" x-cloak>
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Dashboard Overview</h2>
                        <p class="text-gray-600">Welcome to the admin dashboard. Monitor your platform's performance and manage all aspects of your exam portal.</p>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
                        <div class="stat-card bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Users</dt>
                                            <dd class="text-2xl font-bold text-gray-900">{{ stats.total_users }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Exams</dt>
                                            <dd class="text-2xl font-bold text-gray-900">{{ stats.total_exams }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 11.685c.554-1.055 1.689-1.685 2.887-1.685 1.198 0 2.333.63 2.887 1.685m-5.774 0h5.774M12 19c-3.866 0-7-3.133-7-7 0-3.866 3.134-7 7-7s7 3.134 7 7c0 3.867-3.134 7-7 7z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Questions</dt>
                                            <dd class="text-2xl font-bold text-gray-900">{{ stats.total_questions }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Test Attempts</dt>
                                            <dd class="text-2xl font-bold text-gray-900">{{ stats.total_attempts }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Distribution -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">User Distribution</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-blue-500 rounded-full mr-3"></div>
                                        <span class="text-sm font-medium">Students</span>
                                    </div>
                                    <span class="text-sm font-bold">{{ stats.students }}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                        <span class="text-sm font-medium">Teachers</span>
                                    </div>
                                    <span class="text-sm font-bold">{{ stats.teachers }}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-red-500 rounded-full mr-3"></div>
                                        <span class="text-sm font-medium">Admins</span>
                                    </div>
                                    <span class="text-sm font-bold">{{ stats.admins }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">System Health</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Database Status</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        Online
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Server Status</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        Running
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Storage Usage</span>
                                    <span class="text-sm text-gray-600">45% Used</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Recent Activity</h3>
                        </div>
                        <div class="divide-y divide-gray-200">
                            {% for attempt in recent_attempts|slice:":5" %}
                            <div class="px-6 py-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                </svg>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <p class="text-sm font-medium text-gray-900">
                                                {{ attempt.user.first_name }} {{ attempt.user.last_name }}
                                            </p>
                                            <p class="text-sm text-gray-500">
                                                Started test: {{ attempt.test.title }}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        {{ attempt.start_time|timesince }} ago
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- User Management Section -->
                <div id="users-section" x-show="activeSection === 'users'" x-cloak>
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">User Management</h2>
                        <p class="text-gray-600">Manage user accounts, roles, and permissions.</p>
                    </div>

                    <!-- User Statistics -->
                    <div class="grid grid-cols-1 gap-5 sm:grid-cols-3 mb-6">
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Students</dt>
                                            <dd class="text-2xl font-bold text-gray-900">{{ stats.students }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Teachers</dt>
                                            <dd class="text-2xl font-bold text-gray-900">{{ stats.teachers }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Admins</dt>
                                            <dd class="text-2xl font-bold text-gray-900">{{ stats.admins }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Management Tools -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">User Actions</h3>
                            <div class="space-y-3">
                                <a href="{% url 'admin-user-create' %}" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Create New User</span>
                                </a>
                                <a href="{% url 'admin-users-list' %}" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Manage All Users</span>
                                </a>
                                <a href="{% url 'admin-user-groups' %}" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Manage User Groups</span>
                                </a>
                                <a href="{% url 'admin-permissions' %}" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-yellow-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Manage Permissions</span>
                                </a>
                            </div>
                        </div>

                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Bulk Operations</h3>
                            <div class="space-y-3">
                                <button onclick="openBulkUserModal('activate')" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Bulk Activate Users</span>
                                </button>
                                <button onclick="openBulkUserModal('deactivate')" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Bulk Deactivate Users</span>
                                </button>
                                <button onclick="openBulkUserModal('export')" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Export User Data</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- User List -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900">Recent Users</h3>
                            <div class="flex space-x-2">
                                <input type="text" placeholder="Search users..." class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                                <select class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                                    <option value="">All Roles</option>
                                    <option value="student">Students</option>
                                    <option value="teacher">Teachers</option>
                                    <option value="admin">Admins</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Joined</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for user in recent_users %}
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10">
                                                    <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                                        <span class="text-sm font-medium text-blue-600">
                                                            {{ user.first_name.0|default:user.username.0 }}{{ user.last_name.0|default:"" }}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900">
                                                        {{ user.first_name }} {{ user.last_name }}
                                                    </div>
                                                    <div class="text-sm text-gray-500">
                                                        {{ user.email }}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                                {% if user.role == 'admin' %}bg-red-100 text-red-800
                                                {% elif user.role == 'teacher' %}bg-green-100 text-green-800
                                                {% else %}bg-blue-100 text-blue-800{% endif %}">
                                                {{ user.role|title }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {{ user.date_joined|date:"M d, Y" }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            {% if user.is_active %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                Active
                                            </span>
                                            {% else %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                Inactive
                                            </span>
                                            {% endif %}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <a href="{% url 'admin-user-edit' user.id %}" class="text-blue-600 hover:text-blue-900 mr-3">Edit</a>
                                            <button onclick="toggleUserStatus({{ user.id }}, '{{ user.is_active|yesno:"deactivate,activate" }}')" 
                                                    class="{% if user.is_active %}text-red-600 hover:text-red-900{% else %}text-green-600 hover:text-green-900{% endif %}">
                                                {% if user.is_active %}Deactivate{% else %}Activate{% endif %}
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Exam Management Section -->
                <div id="exams-section" x-show="activeSection === 'exams'" x-cloak>
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Exam Management</h2>
                        <p class="text-gray-600">Manage exams, tests, and student performance.</p>
                    </div>

                    <!-- Exam Statistics -->
                    <div class="grid grid-cols-1 gap-5 sm:grid-cols-4 mb-6">
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Exams</dt>
                                            <dd class="text-2xl font-bold text-gray-900">{{ stats.total_exams }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Tests</dt>
                                            <dd class="text-2xl font-bold text-gray-900">{{ stats.total_tests }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Test Attempts</dt>
                                            <dd class="text-2xl font-bold text-gray-900">{{ stats.total_attempts }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2-2V7a2 2 0 012-2h2a2 2 0 002 2v2a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 00-2 2h-2a2 2 0 00-2 2v6a2 2 0 01-2 2H9z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Avg. Score</dt>
                                            <dd class="text-2xl font-bold text-gray-900">78%</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Exam Management Tools -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Exam Actions</h3>
                            <div class="space-y-3">
                                <a href="{% url 'create-exam' %}" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Create New Exam</span>
                                </a>
                                <a href="{% url 'exam-management' %}" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Exam Dashboard</span>
                                </a>
                                <a href="{% url 'admin-exams-list' %}" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Admin Exam Management</span>
                                </a>
                                <a href="/admin/exams/test/" target="_blank" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-orange-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Django Admin (Tests)</span>
                                </a>
                                <button @click="openTestAttemptsModal()" class="w-full flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <svg class="w-5 h-5 text-indigo-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Manage Test Attempts</span>
                                </button>
                            </div>
                        </div>

                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Performance Analytics</h3>
                            <div class="space-y-3">
                                <a href="{% url 'analytics' %}" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2-2V7a2 2 0 012-2h2a2 2 0 002 2v2a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 00-2 2h-2a2 2 0 00-2 2v6a2 2 0 01-2 2H9z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">View Analytics Dashboard</span>
                                </a>
                                <button onclick="exportExamResults()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Export All Results</span>
                                </button>
                                <button onclick="generateReports()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Generate Reports</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Exams Table -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900">Recent Exams</h3>
                            <div class="flex space-x-2">
                                <input type="text" placeholder="Search exams..." class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                                <select class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                                    <option value="">All Categories</option>
                                    <option value="math">Mathematics</option>
                                    <option value="science">Science</option>
                                    <option value="english">English</option>
                                    <option value="history">History</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Exam</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tests</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Attempts</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for exam in recent_exams %}
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10">
                                                    <div class="h-10 w-10 rounded-lg bg-blue-100 flex items-center justify-center">
                                                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900">
                                                        {{ exam.name }}
                                                    </div>
                                                    <div class="text-sm text-gray-500">
                                                        Created {{ exam.created_at|timesince }} ago
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                {{ exam.category|default:"General" }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            {{ exam.tests.count }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            {{ exam.tests.all.0.attempts.count|default:0 }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                                {% if exam.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                                {% if exam.is_active %}Active{% else %}Inactive{% endif %}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <a href="{% url 'exam-detail' exam.id %}" class="text-blue-600 hover:text-blue-900 mr-3">View</a>
                                            <a href="{% url 'admin-exam-edit' exam.id %}" class="text-green-600 hover:text-green-900 mr-3">Edit</a>
                                            <button onclick="toggleExamStatus('{{ exam.id }}', '{{ exam.is_active|yesno:"deactivate,activate" }}')" 
                                                    class="{% if exam.is_active %}text-red-600 hover:text-red-900{% else %}text-green-600 hover:text-green-900{% endif %}">
                                                {% if exam.is_active %}Deactivate{% else %}Activate{% endif %}
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Question Banks Section -->
                <div id="questions-section" x-show="activeSection === 'questions'" x-cloak>
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Question Bank Management</h2>
                        <p class="text-gray-600">Manage question banks and question content.</p>
                    </div>

                    <!-- Question Bank Statistics -->
                    <div class="grid grid-cols-1 gap-5 sm:grid-cols-4 mb-6">
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Question Banks</dt>
                                            <dd class="text-2xl font-bold text-gray-900">{{ stats.total_question_banks }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 11.685c.554-1.055 1.689-1.685 2.887-1.685 1.198 0 2.333.63 2.887 1.685m-5.774 0h5.774M12 19c-3.866 0-7-3.133-7-7 0-3.866 3.134-7 7-7s7 3.134 7 7c0 3.867-3.134 7-7 7z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Questions</dt>
                                            <dd class="text-2xl font-bold text-gray-900">{{ stats.total_questions }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Private Banks</dt>
                                            <dd class="text-2xl font-bold text-gray-900">12</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Public Banks</dt>
                                            <dd class="text-2xl font-bold text-gray-900">8</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Question Bank Management Tools -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Bank Actions</h3>
                            <div class="space-y-3">
                                <a href="{% url 'create-question-bank' %}" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Create Question Bank</span>
                                </a>
                                <a href="{% url 'question-bank-list' %}" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Manage Question Banks</span>
                                </a>
                                {% if features.PDF_EXTRACTOR_ENABLED %}
                                <a href="{% url 'pdf_extractor:home' %}" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-orange-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Extract Questions from PDF</span>
                                </a>
                                {% endif %}
                                <a href="{% url 'admin-questions-list' %}" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Manage Questions</span>
                                </a>
                            </div>
                        </div>

                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Permission Management</h3>
                            <div class="space-y-3">
                                <button @click="openPermissionManager()" class="w-full flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <svg class="w-5 h-5 text-indigo-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Manage Bank Permissions</span>
                                </button>
                                <button @click="openBulkPermissions()" class="w-full flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Bulk Permission Assignment</span>
                                </button>
                                <div class="border-t pt-3 mt-3">
                                    <div class="text-xs text-gray-500 mb-2">Permission Summary</div>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">Private Banks</span>
                                            <span class="text-xs font-medium" id="private-banks-count">-</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">With Permissions</span>
                                            <span class="text-xs font-medium" id="banks-with-permissions">-</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">Total Permissions</span>
                                            <span class="text-xs font-medium" id="total-permissions">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bulk Question Operations -->
                    <div class="bg-white shadow rounded-lg mb-6">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Bulk Operations</h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <button onclick="openBulkImportModal()" class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400">
                                    <div class="text-center">
                                        <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                        </svg>
                                        <span class="text-sm font-medium text-gray-600">Import Questions</span>
                                        <p class="text-xs text-gray-500">CSV or Excel</p>
                                    </div>
                                </button>
                                <button onclick="exportAllQuestions()" class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400">
                                    <div class="text-center">
                                        <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <span class="text-sm font-medium text-gray-600">Export Questions</span>
                                        <p class="text-xs text-gray-500">All banks</p>
                                    </div>
                                </button>
                                <button onclick="validateQuestions()" class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400">
                                    <div class="text-center">
                                        <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="text-sm font-medium text-gray-600">Validate Questions</span>
                                        <p class="text-xs text-gray-500">Check integrity</p>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documents Section -->
                <div id="documents-section" x-show="activeSection === 'documents'" x-cloak>
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Document Management</h2>
                        <p class="text-gray-600">Manage uploaded PDF documents and extraction processes.</p>
                    </div>

                    <!-- Document Statistics -->
                    <div class="grid grid-cols-1 gap-5 sm:grid-cols-4 mb-6">
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Documents</dt>
                                            <dd class="text-2xl font-bold text-gray-900" id="total-documents">-</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Processed</dt>
                                            <dd class="text-2xl font-bold text-gray-900" id="processed-documents">-</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">In Progress</dt>
                                            <dd class="text-2xl font-bold text-gray-900" id="in-progress-documents">-</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h4a1 1 0 011 1v2h4a1 1 0 011 1v2a1 1 0 01-1 1h-1v9a2 2 0 01-2 2H6a2 2 0 01-2-2V8H3a1 1 0 01-1-1V5a1 1 0 011-1h4z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Questions Extracted</dt>
                                            <dd class="text-2xl font-bold text-gray-900" id="extracted-questions">-</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Document Management Tools -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Document Actions</h3>
                            <div class="space-y-3">
                                <button @click="openDocumentViewer()" class="w-full flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">View All Documents</span>
                                </button>
                                <button @click="openProcessingMonitor()" class="w-full flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Processing Monitor</span>
                                </button>
                                <button @click="openDocumentCleanup()" class="w-full flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <svg class="w-5 h-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Cleanup & Maintenance</span>
                                </button>
                                <button @click="openBulkOperations()" class="w-full flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <svg class="w-5 h-5 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Bulk Operations</span>
                                </button>
                            </div>
                        </div>

                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Analytics & Reports</h3>
                            <div class="space-y-3">
                                <button @click="openDocumentAnalytics()" class="w-full flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <svg class="w-5 h-5 text-indigo-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Usage Analytics</span>
                                </button>
                                <button @click="openExtractionReport()" class="w-full flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <svg class="w-5 h-5 text-orange-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Extraction Quality Report</span>
                                </button>
                                <button @click="openUserActivityReport()" class="w-full flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                    <svg class="w-5 h-5 text-teal-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">User Activity Report</span>
                                </button>
                                <div class="border-t pt-3 mt-3">
                                    <div class="text-xs text-gray-500 mb-2">Quick Stats</div>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">Avg. Processing Time</span>
                                            <span class="text-xs font-medium" id="avg-processing-time">-</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">Success Rate</span>
                                            <span class="text-xs font-medium" id="extraction-success-rate">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Recent Document Activity</h3>
                        </div>
                        <div class="px-6 py-4">
                            <div class="flow-root">
                                <ul id="document-activity-list" class="divide-y divide-gray-200">
                                    <li class="py-3">
                                        <div class="flex items-center space-x-4">
                                            <div class="flex-shrink-0">
                                                <div class="h-8 w-8 bg-blue-100 rounded-full flex items-center justify-center">
                                                    <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm text-gray-600">Loading recent activity...</p>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subscription Management Section -->
                <div id="subscriptions-section" x-show="activeSection === 'subscriptions'" x-cloak>
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Subscription Management</h2>
                        <p class="text-gray-600">Manage user subscriptions and pricing plans.</p>
                    </div>

                    <!-- Subscription Statistics -->
                    <div class="grid grid-cols-1 gap-5 sm:grid-cols-4 mb-6">
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Active Subscriptions</dt>
                                            <dd class="text-2xl font-bold text-gray-900">{{ stats.active_subscriptions }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Revenue</dt>
                                            <dd class="text-2xl font-bold text-gray-900">${{ stats.total_revenue|floatformat:2 }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Expiring Soon</dt>
                                            <dd class="text-2xl font-bold text-gray-900">23</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Cancelled</dt>
                                            <dd class="text-2xl font-bold text-gray-900">12</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Subscription Plans -->
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 mb-8">
                        {% for plan in subscription_plans %}
                        <div class="bg-white {% if plan.is_popular %}shadow-lg border-2 border-blue-500{% else %}shadow{% endif %} rounded-lg">
                            <div class="p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-medium text-gray-900">{{ plan.name }}</h3>
                                    {% if plan.is_popular %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        Popular
                                    </span>
                                    {% else %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 capitalize">
                                        {{ plan.plan_type }}
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="text-3xl font-bold text-gray-900 mb-2">${{ plan.price }}<span class="text-base font-normal text-gray-500">/{{ plan.billing_cycle }}</span></div>
                                <ul class="text-sm text-gray-600 space-y-2 mb-6">
                                    {% for feature in plan.features_list|slice:":3" %}
                                    <li class="flex items-center">
                                        <svg class="w-4 h-4 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        {{ feature }}
                                    </li>
                                    {% endfor %}
                                </ul>
                                <div class="text-center">
                                    <span class="text-2xl font-bold text-blue-600">{{ plan.subscriptions.count }} users</span>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-span-3 text-center p-6">
                            <p class="text-gray-500">No subscription plans created yet</p>
                            <button onclick="createSubscriptionPlan()" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                                Create First Plan
                            </button>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Subscription Management Tools -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Subscription Actions</h3>
                            <div class="space-y-3">
                                <button onclick="createSubscriptionPlan()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Create New Plan</span>
                                </button>
                                <button onclick="viewAllSubscriptions()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                    </svg>
                                    <span class="text-sm font-medium">View All Subscriptions</span>
                                </button>
                                <button onclick="manageDiscounts()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Manage Discounts</span>
                                </button>
                            </div>
                        </div>

                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Recent Subscriptions</h3>
                            <div class="space-y-3">
                                {% for subscription in recent_subscriptions %}
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">{{ subscription.user.username }}</p>
                                        <p class="text-xs text-gray-500">{{ subscription.plan.name }} - ${{ subscription.plan.price }}/{{ subscription.plan.billing_cycle }}</p>
                                    </div>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                        {% if subscription.status == 'active' %}bg-green-100 text-green-800
                                        {% elif subscription.status == 'trial' %}bg-blue-100 text-blue-800
                                        {% elif subscription.status == 'cancelled' %}bg-red-100 text-red-800
                                        {% elif subscription.status == 'expired' %}bg-gray-100 text-gray-800
                                        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                        {{ subscription.status|title }}
                                    </span>
                                </div>
                                {% empty %}
                                <div class="text-center p-3">
                                    <p class="text-sm text-gray-500">No subscriptions yet</p>
                                    <a href="/payments/plans/" class="text-blue-600 hover:text-blue-800 text-sm">View plans</a>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Management Section -->
                <div id="payments-section" x-show="activeSection === 'payments'" x-cloak>
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Payment Management</h2>
                        <p class="text-gray-600">Monitor payments, transactions, and billing.</p>
                    </div>

                    <!-- Payment Statistics -->
                    <div class="grid grid-cols-1 gap-5 sm:grid-cols-4 mb-6">
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Pending Payments</dt>
                                            <dd class="text-2xl font-bold text-gray-900">{{ stats.pending_payments }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Successful Payments</dt>
                                            <dd class="text-2xl font-bold text-gray-900">2,847</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Pending</dt>
                                            <dd class="text-2xl font-bold text-gray-900">34</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                                            <svg class="h-5 w-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Failed</dt>
                                            <dd class="text-2xl font-bold text-gray-900">89</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Management Tools -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Payment Actions</h3>
                            <div class="space-y-3">
                                <button onclick="configurePaymentGateways()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Configure Payment Gateways</span>
                                </button>
                                <button onclick="viewAllTransactions()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                    </svg>
                                    <span class="text-sm font-medium">View All Transactions</span>
                                </button>
                                <button onclick="processRefunds()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-orange-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M8 11h8m4 0v6a2 2 0 01-2 2H6a2 2 0 01-2-2v-6a2 2 0 012-2h12a2 2 0 012 2z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Process Refunds</span>
                                </button>
                                <button onclick="generateInvoices()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Generate Invoices</span>
                                </button>
                            </div>
                        </div>

                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Payment Gateways</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">Stripe</p>
                                            <p class="text-xs text-gray-500">Credit Cards, ACH</p>
                                        </div>
                                    </div>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        Active
                                    </span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                                            <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">PayPal</p>
                                            <p class="text-xs text-gray-500">PayPal, Credit Cards</p>
                                        </div>
                                    </div>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        Active
                                    </span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center mr-3">
                                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">Razorpay</p>
                                            <p class="text-xs text-gray-500">Indian Payments</p>
                                        </div>
                                    </div>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        Inactive
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900">Recent Transactions</h3>
                            <div class="flex space-x-2">
                                <input type="text" placeholder="Search transactions..." class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                                <select class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                                    <option value="">All Status</option>
                                    <option value="completed">Completed</option>
                                    <option value="pending">Pending</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaction ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plan</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gateway</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for payment in recent_payments %}
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                            {% if payment.gateway_transaction_id %}
                                                {{ payment.gateway_transaction_id }}
                                            {% else %}
                                                PAY-{{ payment.id|truncatechars:8 }}
                                            {% endif %}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ payment.user.username }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ payment.plan.name }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${{ payment.amount }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">{{ payment.gateway }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                                {% if payment.status == 'completed' %}bg-green-100 text-green-800
                                                {% elif payment.status == 'pending' %}bg-yellow-100 text-yellow-800
                                                {% elif payment.status == 'failed' %}bg-red-100 text-red-800
                                                {% elif payment.status == 'refunded' %}bg-purple-100 text-purple-800
                                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                {{ payment.status|title }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ payment.created_at|date:"M d, Y" }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                            No transactions yet
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Global Topic Taxonomy Section -->
                <div id="taxonomy-section" x-show="activeSection === 'taxonomy'" x-cloak>
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Global Topic Taxonomy</h2>
                        <p class="text-gray-600">Manage subjects, topics, and curriculum structures for content creation and exam planning.</p>
                    </div>

                    <!-- Taxonomy Statistics -->
                    <div class="grid grid-cols-1 gap-5 sm:grid-cols-4 mb-6">
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Subjects</dt>
                                            <dd class="text-2xl font-bold text-gray-900" id="totalSubjects">{{ taxonomy_stats.total_subjects|default:0 }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Topics</dt>
                                            <dd class="text-2xl font-bold text-gray-900" id="totalTopics">{{ taxonomy_stats.total_topics|default:0 }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Templates</dt>
                                            <dd class="text-2xl font-bold text-gray-900" id="totalTemplates">{{ taxonomy_stats.total_templates|default:0 }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Pending Approval</dt>
                                            <dd class="text-2xl font-bold text-gray-900" id="pendingApproval">{{ taxonomy_stats.pending_approval|default:0 }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Topic Management Tools -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Subject Management</h3>
                            <div class="space-y-3">
                                <button onclick="showCreateSubjectModal()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    <span class="text-sm font-medium">Create New Subject</span>
                                </button>
                                <button onclick="viewAllSubjects()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14-7H5m14 14H5m14-7H5"/>
                                    </svg>
                                    <span class="text-sm font-medium">View All Subjects</span>
                                </button>
                                <button onclick="manageSubjectCategories()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                                    </svg>
                                    <span class="text-sm font-medium">Manage Categories</span>
                                </button>
                            </div>
                        </div>

                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Topic Management</h3>
                            <div class="space-y-3">
                                <button onclick="showCreateTopicModal()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <span class="text-sm font-medium">Create New Topic</span>
                                </button>
                                <button onclick="viewPendingApprovals()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-yellow-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span class="text-sm font-medium">Pending Approvals</span>
                                </button>
                                <button onclick="manageTopicHierarchy()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h2a2 2 0 012 2v0H8v0z"/>
                                    </svg>
                                    <span class="text-sm font-medium">Topic Hierarchy</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Template Management -->
                    <div class="bg-white shadow rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Template Management</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button onclick="showCreateTemplateModal()" class="flex flex-col items-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-400 hover:bg-blue-50">
                                <svg class="w-8 h-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                                <span class="text-sm font-medium text-gray-600">Create Template</span>
                            </button>
                            <button onclick="viewAllTemplates()" class="flex flex-col items-center p-4 border-2 border-gray-200 rounded-lg hover:border-green-400 hover:bg-green-50">
                                <svg class="w-8 h-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                                <span class="text-sm font-medium text-gray-600">View Templates</span>
                            </button>
                            <button onclick="importFromTemplate()" class="flex flex-col items-center p-4 border-2 border-gray-200 rounded-lg hover:border-purple-400 hover:bg-purple-50">
                                <svg class="w-8 h-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                                </svg>
                                <span class="text-sm font-medium text-gray-600">Import Topics</span>
                            </button>
                        </div>
                    </div>

                    <!-- Usage Analytics -->
                    <div class="bg-white shadow rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Usage Analytics</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-sm font-medium text-gray-700 mb-3">Popular Subjects</h4>
                                <div id="popularSubjects" class="space-y-2">
                                    <!-- Popular subjects will be loaded here -->
                                    <div class="text-sm text-gray-500">Loading...</div>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-gray-700 mb-3">Most Used Topics</h4>
                                <div id="popularTopics" class="space-y-2">
                                    <!-- Popular topics will be loaded here -->
                                    <div class="text-sm text-gray-500">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Settings Section -->
                <div id="settings-section" x-show="activeSection === 'settings'" x-cloak>
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">System Settings</h2>
                        <p class="text-gray-600">Configure system-wide settings and preferences.</p>
                    </div>

                    <!-- System Settings Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Platform Configuration</h3>
                            <div class="space-y-3">
                                <a href="/admin/sites/site/" target="_blank" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Site Configuration</span>
                                </a>
                                <a href="{% url 'admin-user-groups' %}" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">User Groups & Permissions</span>
                                </a>
                                <a href="{% url 'admin-email-settings' %}" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Email Settings</span>
                                </a>
                                <a href="/admin/" target="_blank" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Full Django Admin</span>
                                </a>
                            </div>
                        </div>

                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">System Health</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Database Connection</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        Healthy
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Cache System</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        Online
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Email Service</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        Active
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Storage Space</span>
                                    <span class="text-sm font-bold text-yellow-600">67% Used</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System Information -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Technical Details</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Django Version</span>
                                    <span class="text-sm text-gray-600">5.2.4</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Python Version</span>
                                    <span class="text-sm text-gray-600">3.11.0</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Database</span>
                                    <span class="text-sm text-gray-600">PostgreSQL 15</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Cache Backend</span>
                                    <span class="text-sm text-gray-600">Redis 7.0</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Debug Mode</span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        Enabled
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white shadow rounded-lg p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Maintenance</h3>
                            <div class="space-y-3">
                                <button onclick="clearCache()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Clear Cache</span>
                                </button>
                                <button onclick="runMigrations()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Run Migrations</span>
                                </button>
                                <button onclick="collectStatic()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Collect Static Files</span>
                                </button>
                                <button onclick="viewLogs()" class="flex items-center w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <svg class="w-5 h-5 text-orange-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">View System Logs</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div class="bg-white shadow rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Security & Backups</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button onclick="createBackup()" class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400">
                                <div class="text-center">
                                    <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <span class="text-sm font-medium text-gray-600">Create Backup</span>
                                    <p class="text-xs text-gray-500">Database & Files</p>
                                </div>
                            </button>
                            <button onclick="auditSecurity()" class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400">
                                <div class="text-center">
                                    <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                    </svg>
                                    <span class="text-sm font-medium text-gray-600">Security Audit</span>
                                    <p class="text-xs text-gray-500">System scan</p>
                                </div>
                            </button>
                            <button onclick="monitorPerformance()" class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400">
                                <div class="text-center">
                                    <svg class="mx-auto h-8 w-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2-2V7a2 2 0 012-2h2a2 2 0 002 2v2a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 00-2 2h-2a2 2 0 00-2 2v6a2 2 0 01-2 2H9z"></path>
                                    </svg>
                                    <span class="text-sm font-medium text-gray-600">Performance Monitor</span>
                                    <p class="text-xs text-gray-500">System metrics</p>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div x-show="sidebarOpen && isMobile" 
         @click="sidebarOpen = false"
         class="fixed inset-0 bg-gray-600 bg-opacity-50 z-20 lg:hidden"
         x-transition:enter="transition-opacity ease-linear duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition-opacity ease-linear duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
    </div>
</div>

<!-- Create Plan Modal -->
<div id="createPlanModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="hideCreatePlanModal()"></div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <form onsubmit="createPlan(event)">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Create New Subscription Plan</h3>
                    
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Plan Name</label>
                            <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Plan Type</label>
                            <select name="plan_type" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select type</option>
                                <option value="basic">Basic</option>
                                <option value="pro">Pro</option>
                                <option value="enterprise">Enterprise</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
                            <input type="number" name="price" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Billing Cycle</label>
                            <select name="billing_cycle" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select cycle</option>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                                <option value="lifetime">Lifetime</option>
                            </select>
                        </div>
                        
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea name="description" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Max Tests</label>
                            <input type="number" name="max_tests" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="-1 for unlimited">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Max Questions</label>
                            <input type="number" name="max_questions" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="-1 for unlimited">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Trial Days</label>
                            <input type="number" name="trial_days" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Features</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="pdf_extraction" class="mr-2">
                                    <span class="text-sm">PDF Extraction</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="analytics_access" class="mr-2">
                                    <span class="text-sm">Advanced Analytics</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="priority_support" class="mr-2">
                                    <span class="text-sm">Priority Support</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="custom_branding" class="mr-2">
                                    <span class="text-sm">Custom Branding</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="api_access" class="mr-2">
                                    <span class="text-sm">API Access</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Create Plan
                    </button>
                    <button type="button" onclick="hideCreatePlanModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Subscriptions Modal -->
<div id="subscriptionsModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="hideSubscriptionsModal()"></div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">All Subscriptions</h3>
                    <button onclick="hideSubscriptionsModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plan</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for subscription in recent_subscriptions %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">{{ subscription.user.username }}</div>
                                    <div class="text-sm text-gray-500">{{ subscription.user.email }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ subscription.plan.name }}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                        {% if subscription.status == 'active' %}bg-green-100 text-green-800
                                        {% elif subscription.status == 'trial' %}bg-blue-100 text-blue-800
                                        {% elif subscription.status == 'cancelled' %}bg-red-100 text-red-800
                                        {% elif subscription.status == 'expired' %}bg-gray-100 text-gray-800
                                        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                        {{ subscription.status|title }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ subscription.start_date|date:"M d, Y" }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ subscription.end_date|date:"M d, Y" }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button class="text-blue-600 hover:text-blue-900 mr-2">View</button>
                                    {% if subscription.status == 'active' %}
                                    <button class="text-red-600 hover:text-red-900">Cancel</button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                                    No subscriptions found
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Discounts Modal -->
<div id="discountsModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="hideDiscountsModal()"></div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Manage Discount Codes</h3>
                    <button onclick="showCreateDiscountForm()" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        New Discount
                    </button>
                </div>
                
                <!-- Create Discount Form (Initially Hidden) -->
                <div id="createDiscountForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                    <form onsubmit="createDiscount(event)">
                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Discount Code</label>
                                <input type="text" name="code" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g., SAVE20">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g., Summer Sale">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                <select name="discount_type" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="percentage">Percentage</option>
                                    <option value="fixed">Fixed Amount</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Value</label>
                                <input type="number" name="value" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Valid From</label>
                                <input type="date" name="valid_from" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Valid Until</label>
                                <input type="date" name="valid_until" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                        
                        <div class="mt-4 flex justify-end space-x-2">
                            <button type="button" onclick="hideCreateDiscountForm()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">Create Discount</button>
                        </div>
                    </form>
                </div>
                
                <!-- Existing Discounts List -->
                <div class="space-y-3">
                    {% for discount in active_discounts %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-900">{{ discount.code }}</div>
                            <div class="text-sm text-gray-500">
                                {{ discount.value|floatformat:0 }}{% if discount.discount_type == 'percentage' %}%{% else %}${% endif %} off - 
                                Used {{ discount.used_count }} times
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Active
                            </span>
                            <button class="text-red-600 hover:text-red-800 text-sm">Deactivate</button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-8 text-gray-500">
                        No discount codes created yet
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-end">
                <button onclick="hideDiscountsModal()" class="inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Gateways Modal -->
<div id="paymentGatewaysModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="hidePaymentGatewaysModal()"></div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Configure Payment Gateways</h3>
                    <button onclick="hidePaymentGatewaysModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <form onsubmit="saveGatewayConfig(event)">
                    <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                        <!-- Stripe Configuration -->
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <h4 class="text-md font-semibold text-gray-900 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                </svg>
                                Stripe Configuration
                            </h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Publishable Key</label>
                                    <input type="text" name="stripe_publishable_key" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="pk_test_...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Secret Key</label>
                                    <input type="password" name="stripe_secret_key" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="sk_test_...">
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="stripe_enabled" id="stripe_enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="stripe_enabled" class="ml-2 block text-sm text-gray-900">Enable Stripe</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Razorpay Configuration -->
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <h4 class="text-md font-semibold text-gray-900 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                Razorpay Configuration
                            </h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Key ID</label>
                                    <input type="text" name="razorpay_key_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="rzp_test_...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Key Secret</label>
                                    <input type="password" name="razorpay_key_secret" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter secret...">
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" name="razorpay_enabled" id="razorpay_enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="razorpay_enabled" class="ml-2 block text-sm text-gray-900">Enable Razorpay</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" onclick="hidePaymentGatewaysModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Transactions Modal -->
<div id="transactionsModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="hideTransactionsModal()"></div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">All Transactions</h3>
                    <button onclick="hideTransactionsModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaction ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plan</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gateway</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">Loading transactions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-end">
                <button onclick="hideTransactionsModal()" class="inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Refunds Modal -->
<div id="refundsModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="hideRefundsModal()"></div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Process Refunds</h3>
                    <button onclick="hideRefundsModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4 p-4 bg-orange-50 border border-orange-200 rounded-md">
                    <div class="flex">
                        <svg class="w-5 h-5 text-orange-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <div>
                            <h4 class="text-sm font-medium text-orange-800">Refund Policy</h4>
                            <p class="text-sm text-orange-700 mt-1">Only completed transactions are eligible for refunds. Please verify transaction details before processing.</p>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaction ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plan</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="refundTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">Loading refundable transactions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-end">
                <button onclick="hideRefundsModal()" class="inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Generate Invoices Modal -->
<div id="invoicesModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="hideInvoicesModal()"></div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-5xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Generate Invoices</h3>
                    <button onclick="hideInvoicesModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-blue-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <h4 class="text-sm font-medium text-blue-800">Invoice Generation</h4>
                                <p class="text-sm text-blue-700 mt-1">Generate invoices for <span id="pendingPaymentCount" class="font-semibold">0</span> pending payments.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto mb-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaction ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plan</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">Loading pending payments...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-between">
                <button onclick="generateAllInvoices()" class="inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-purple-600 text-base font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 sm:text-sm">
                    Generate All Invoices
                </button>
                <button onclick="hideInvoicesModal()" class="inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Attempts Management Modal -->
<div id="testAttemptsModal" class="fixed inset-0 z-50 overflow-y-auto hidden" style="background-color: rgba(0, 0, 0, 0.5);">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-white flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        Manage Test Attempts
                    </h3>
                    <button onclick="closeTestAttemptsModal()" class="text-white hover:text-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="bg-white px-6 py-6">
                <!-- Search and Bulk Actions -->
                <div class="mb-4 flex flex-col sm:flex-row justify-between gap-4">
                    <div class="flex-1">
                        <input type="text" id="testSearchInput" placeholder="Search tests by title or exam name..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                               onkeyup="searchTests()">
                    </div>
                    <div class="flex gap-2">
                        <select id="bulkMaxAttempts" class="px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Bulk Set Attempts</option>
                            <option value="1">1 Attempt</option>
                            <option value="2">2 Attempts</option>
                            <option value="3">3 Attempts</option>
                            <option value="5">5 Attempts</option>
                            <option value="10">10 Attempts</option>
                            <option value="999">Unlimited</option>
                        </select>
                        <button onclick="bulkUpdateAttempts()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            Apply to Selected
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="testAttemptsLoading" class="text-center py-8">
                    <svg class="animate-spin h-8 w-8 mx-auto text-indigo-600" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2 text-gray-600">Loading tests...</p>
                </div>

                <!-- Tests Table -->
                <div id="testAttemptsTable" class="hidden overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-3 py-3 text-left">
                                    <input type="checkbox" id="selectAllTests" onchange="toggleAllTests(this)"
                                           class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test Title</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Exam</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Marks</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Attempts</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Taken</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max Attempts</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="testAttemptsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="testAttemptsEmpty" class="hidden text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No tests found</h3>
                    <p class="mt-1 text-sm text-gray-500">Try adjusting your search criteria.</p>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="bg-gray-50 px-6 py-4 flex justify-end">
                <button onclick="closeTestAttemptsModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function adminDashboard() {
    return {
        activeSection: 'dashboard',
        sidebarOpen: false,
        isMobile: window.innerWidth < 1024,
        
        init() {
            // Listen for window resize
            window.addEventListener('resize', () => {
                this.isMobile = window.innerWidth < 1024;
                if (!this.isMobile) {
                    this.sidebarOpen = false;
                }
            });
            
            // Handle hash navigation
            const hash = window.location.hash.substring(1);
            if (hash) {
                this.activeSection = hash;
            }
        },
        
        setActiveSection(section) {
            this.activeSection = section;
            window.location.hash = section;
            
            // Close sidebar on mobile after selection
            if (this.isMobile) {
                this.sidebarOpen = false;
            }
            
            // Load document stats when documents section is activated
            if (section === 'documents') {
                setTimeout(() => {
                    if (typeof loadDocumentStats === 'function') {
                        loadDocumentStats();
                    }
                }, 100);
            }
            
            // Load taxonomy data when taxonomy section is activated
            if (section === 'taxonomy') {
                setTimeout(() => {
                    if (typeof loadTaxonomyData === 'function') {
                        loadTaxonomyData();
                    }
                }, 100);
            }
        }
    }
}

// Bulk Operations Functions
function openBulkUserModal(operation) {
    if (operation === 'export') {
        // Direct export - no need for modal
        if (confirm('Export all user data to CSV?')) {
            window.location.href = '{% url "admin-export-users" %}';
        }
        return;
    }
    
    // Get all user checkboxes (we'll need to add these to the user list)
    const checkboxes = document.querySelectorAll('input[name="user_ids"]:checked');
    const userIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (userIds.length === 0) {
        alert('Please select users to ' + operation + ' first.');
        return;
    }
    
    const operationText = operation === 'activate' ? 'activate' : 'deactivate';
    const confirmation = confirm(`Are you sure you want to ${operationText} ${userIds.length} selected user(s)?`);
    
    if (confirmation) {
        performBulkOperation(operation, userIds);
    }
}

function performBulkOperation(operation, userIds) {
    const url = operation === 'activate' 
        ? '{% url "admin-bulk-activate-users" %}'
        : '{% url "admin-bulk-deactivate-users" %}';
    
    fetch(url, {
        method: 'POST', 
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            user_ids: userIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // Refresh to show updated status
        } else {
            alert(data.error || 'An error occurred');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during the operation');
    });
}

function toggleUserStatus(userId, action) {
    if (confirm(`Are you sure you want to ${action} this user?`)) {
        fetch(`/users/admin/users/${userId}/toggle-status/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'An error occurred');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}

// Payment and Subscription Management Functions
function createSubscriptionPlan() {
    showCreatePlanModal();
}

function viewAllSubscriptions() {
    showSubscriptionsModal();
}

function manageDiscounts() {
    showDiscountsModal();
}

function configurePaymentGateways() {
    showPaymentGatewaysModal();
}

function viewAllTransactions() {
    showTransactionsModal();
}

function processRefunds() {
    showRefundsModal();
}

function generateInvoices() {
    showInvoicesModal();
}

// System Maintenance Functions
function clearCache() {
    if (confirm('Clear all system cache?')) {
        fetch('/api/admin/clear-cache/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            alert(data.success ? 'Cache cleared successfully!' : 'Error clearing cache');
        });
    }
}

function runMigrations() {
    if (confirm('Run database migrations?')) {
        alert('Migrations should be run from the command line for safety.');
    }
}

function collectStatic() {
    if (confirm('Collect static files?')) {
        fetch('/api/admin/collect-static/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            alert(data.success ? 'Static files collected successfully!' : 'Error collecting static files');
        });
    }
}

function viewLogs() {
    window.open('/admin/log/', '_blank');
}

function createBackup() {
    if (confirm('Create system backup? This may take a few minutes.')) {
        fetch('/api/admin/create-backup/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            alert(data.success ? 'Backup created successfully!' : 'Error creating backup');
        });
    }
}

function auditSecurity() {
    if (confirm('Run security audit?')) {
        fetch('/api/admin/security-audit/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || 'Security audit completed');
        });
    }
}

function monitorPerformance() {
    window.open('/admin/performance/', '_blank');
}

// Modal Functions for Payment/Subscription Features
function showCreatePlanModal() {
    document.getElementById('createPlanModal').classList.remove('hidden');
}

function hideCreatePlanModal() {
    document.getElementById('createPlanModal').classList.add('hidden');
}

function showSubscriptionsModal() {
    // Load subscription data and show modal
    loadSubscriptionData();
    document.getElementById('subscriptionsModal').classList.remove('hidden');
}

function hideSubscriptionsModal() {
    document.getElementById('subscriptionsModal').classList.add('hidden');
}

function showDiscountsModal() {
    // Load discount data and show modal
    loadDiscountData();
    document.getElementById('discountsModal').classList.remove('hidden');
}

function hideDiscountsModal() {
    document.getElementById('discountsModal').classList.add('hidden');
}

function createPlan(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = {
        action: 'create_plan'
    };
    
    for (let [key, value] of formData.entries()) {
        if (key === 'pdf_extraction' || key === 'analytics_access' || key === 'priority_support' || 
            key === 'custom_branding' || key === 'api_access') {
            data[key] = formData.has(key);
        } else {
            data[key] = value;
        }
    }
    
    fetch('/payments/admin/subscriptions/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Subscription plan created successfully!');
            location.reload();
        } else {
            alert(result.error || 'Error creating plan');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating plan');
    });
}

function loadSubscriptionData() {
    // This would load subscription data via AJAX
    console.log('Loading subscription data...');
}

function loadDiscountData() {
    // This would load discount data via AJAX
    console.log('Loading discount data...');
}

function createDiscount(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        if (key === 'applicable_plans') {
            if (!data.applicable_plans) data.applicable_plans = [];
            if (value) data.applicable_plans.push(value);
        } else {
            data[key] = value;
        }
    }
    
    fetch('/payments/api/create-discount/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Discount created successfully!');
            hideDiscountsModal();
            // Optionally reload or update the discounts list
        } else {
            alert(result.error || 'Error creating discount');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating discount');
    });
}

// Helper functions for discount management
function showCreateDiscountForm() {
    document.getElementById('createDiscountForm').classList.remove('hidden');
    document.getElementById('discountsList').classList.add('hidden');
    
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    document.querySelector('#createDiscountForm input[name="valid_from"]').value = today;
    
    const nextMonth = new Date();
    nextMonth.setMonth(nextMonth.getMonth() + 1);
    document.querySelector('#createDiscountForm input[name="valid_until"]').value = nextMonth.toISOString().split('T')[0];
}

function hideCreateDiscountForm() {
    document.getElementById('createDiscountForm').classList.add('hidden');
    document.getElementById('discountsList').classList.remove('hidden');
}

// Payment Actions Modal Functions
function showPaymentGatewaysModal() {
    loadPaymentGatewayData();
    document.getElementById('paymentGatewaysModal').classList.remove('hidden');
}

function hidePaymentGatewaysModal() {
    document.getElementById('paymentGatewaysModal').classList.add('hidden');
}

function showTransactionsModal() {
    loadTransactionData();
    document.getElementById('transactionsModal').classList.remove('hidden');
}

function hideTransactionsModal() {
    document.getElementById('transactionsModal').classList.add('hidden');
}

function showRefundsModal() {
    loadRefundData();
    document.getElementById('refundsModal').classList.remove('hidden');
}

function hideRefundsModal() {
    document.getElementById('refundsModal').classList.add('hidden');
}

function showInvoicesModal() {
    loadInvoiceData();
    document.getElementById('invoicesModal').classList.remove('hidden');
}

function hideInvoicesModal() {
    document.getElementById('invoicesModal').classList.add('hidden');
}

// Data loading functions for payment modals
function loadPaymentGatewayData() {
    console.log('Loading payment gateway data...');
    // This will be populated with actual gateway configurations
}

function loadTransactionData() {
    console.log('Loading transaction data...');
    // Load recent transactions via AJAX
    fetch('/payments/admin/transactions/', {
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.text())
    .then(html => {
        // Extract transaction table data and populate modal
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const transactionTable = doc.querySelector('tbody');
        if (transactionTable) {
            document.getElementById('transactionTableBody').innerHTML = transactionTable.innerHTML;
        }
    })
    .catch(error => {
        console.error('Error loading transaction data:', error);
    });
}

function loadRefundData() {
    console.log('Loading refund data...');
    // Load refundable transactions
    fetch('/payments/admin/transactions/', {
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.text())
    .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const refundableTransactions = Array.from(doc.querySelectorAll('tbody tr')).filter(row => {
            const statusCell = row.querySelector('td:nth-child(6)');
            return statusCell && statusCell.textContent.trim().toLowerCase() === 'completed';
        });
        
        const refundTableBody = document.getElementById('refundTableBody');
        refundTableBody.innerHTML = '';
        
        if (refundableTransactions.length === 0) {
            refundTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No completed transactions available for refund</td></tr>';
            return;
        }
        
        refundableTransactions.forEach(row => {
            const clonedRow = row.cloneNode(true);
            // Remove the original actions column and add refund button
            const cells = clonedRow.querySelectorAll('td');
            if (cells.length > 6) {
                cells[cells.length - 1].remove(); // Remove original actions column
            }
            
            // Extract transaction ID from the first cell
            const transactionId = cells[0].textContent.trim();
            
            // Add refund action column
            const actionCell = document.createElement('td');
            actionCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
            actionCell.innerHTML = `<button onclick="processRefund('${transactionId}')" class="text-red-600 hover:text-red-900">Process Refund</button>`;
            clonedRow.appendChild(actionCell);
            
            refundTableBody.appendChild(clonedRow);
        });
    })
    .catch(error => {
        console.error('Error loading refund data:', error);
        document.getElementById('refundTableBody').innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-red-500">Error loading refund data</td></tr>';
    });
}

function loadInvoiceData() {
    console.log('Loading invoice data...');
    // Load pending payments for invoice generation
    fetch('/payments/admin/transactions/', {
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.text())
    .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const pendingTransactions = Array.from(doc.querySelectorAll('tbody tr')).filter(row => {
            const statusCell = row.querySelector('td:nth-child(6)');
            return statusCell && statusCell.textContent.trim().toLowerCase() === 'pending';
        });
        
        const invoiceTableBody = document.getElementById('invoiceTableBody');
        invoiceTableBody.innerHTML = '';
        pendingTransactions.forEach(row => {
            invoiceTableBody.appendChild(row.cloneNode(true));
        });
        
        document.getElementById('pendingPaymentCount').textContent = pendingTransactions.length;
    })
    .catch(error => {
        console.error('Error loading invoice data:', error);
    });
}

// Payment gateway configuration functions
function saveGatewayConfig(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // This would normally save to backend
    console.log('Saving gateway config:', data);
    alert('Payment gateway configuration saved successfully!');
    hidePaymentGatewaysModal();
}

// Process refund function
function processRefund(transactionId) {
    if (confirm('Are you sure you want to process a refund for this transaction?')) {
        fetch('/payments/api/process-refund/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({
                transaction_id: transactionId
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Refund processed successfully!');
                loadRefundData(); // Refresh the data
            } else {
                alert(result.error || 'Error processing refund');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error processing refund');
        });
    }
}

// Generate invoices function
function generateAllInvoices() {
    if (confirm('Generate invoices for all pending payments?')) {
        fetch('/payments/api/generate-invoices/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(result.message || 'Invoices generated successfully!');
                loadInvoiceData(); // Refresh the data
            } else {
                alert(result.error || 'Error generating invoices');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error generating invoices');
        });
    }
}

// Question Bank Permission Management Functions
function openPermissionManager() {
    // Create and show the permission manager modal
    showPermissionManagerModal();
    loadQuestionBankPermissions();
}

function openBulkPermissions() {
    showBulkPermissionModal();
    loadTeachersAndBanks();
}

function showPermissionManagerModal() {
    // Create modal HTML
    const modalHTML = `
        <div id="permissionManagerModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-8 mx-auto p-5 border max-w-6xl shadow-lg rounded-md bg-white">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Question Bank Permissions</h3>
                    <button onclick="closePermissionManager()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <input type="text" id="bankSearchInput" placeholder="Search question banks..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div id="questionBanksList" class="space-y-4 max-h-96 overflow-y-auto">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
                        <p class="mt-2 text-gray-500">Loading question banks...</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function showBulkPermissionModal() {
    const modalHTML = `
        <div id="bulkPermissionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-8 mx-auto p-5 border max-w-4xl shadow-lg rounded-md bg-white">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Bulk Permission Assignment</h3>
                    <button onclick="closeBulkPermissionModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <form id="bulkPermissionForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Teachers</label>
                            <div id="teachersList" class="border border-gray-300 rounded-md max-h-40 overflow-y-auto p-2">
                                <div class="text-center py-4">Loading teachers...</div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Question Banks</label>
                            <div id="banksList" class="border border-gray-300 rounded-md max-h-40 overflow-y-auto p-2">
                                <div class="text-center py-4">Loading banks...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Permission Type</label>
                            <select id="bulkPermissionType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="view">View Only</option>
                                <option value="edit">View & Edit</option>
                                <option value="copy">View & Copy Questions</option>
                                <option value="full">Full Access</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Action</label>
                            <select id="bulkAction" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="grant">Grant Permissions</option>
                                <option value="revoke">Revoke Permissions</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="closeBulkPermissionModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Apply Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function loadQuestionBankPermissions() {
    fetch('/users/admin/api/question-bank-permissions/')
        .then(response => response.json())
        .then(data => {
            displayQuestionBanks(data.question_banks);
            updatePermissionSummary(data.question_banks);
        })
        .catch(error => {
            console.error('Error loading permissions:', error);
        });
}

function displayQuestionBanks(banks) {
    const container = document.getElementById('questionBanksList');
    if (!banks || banks.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">No question banks found</div>';
        return;
    }
    
    const html = banks.map(bank => `
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h4 class="font-medium text-gray-900">${bank.name}</h4>
                    <p class="text-sm text-gray-600">${bank.description || 'No description'}</p>
                    <div class="flex items-center mt-1 space-x-4">
                        <span class="text-xs text-gray-500">Created by: ${bank.created_by}</span>
                        <span class="text-xs text-gray-500">${bank.total_questions} questions</span>
                        <span class="text-xs ${bank.is_public ? 'text-green-600' : 'text-red-600'}">${bank.is_public ? 'Public' : 'Private'}</span>
                    </div>
                </div>
                <button onclick="showAddPermissionForm('${bank.id}', '${bank.name}')" 
                        class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                    Add Permission
                </button>
            </div>
            
            <div class="space-y-2">
                ${bank.permissions.length === 0 ? 
                    '<p class="text-sm text-gray-500 italic">No permissions granted</p>' :
                    bank.permissions.map(perm => `
                        <div class="flex justify-between items-center bg-white p-2 rounded border">
                            <div class="flex-1">
                                <span class="font-medium text-sm">${perm.user_name}</span>
                                <span class="text-xs text-gray-500 ml-2">(${perm.user_email})</span>
                                <span class="ml-3 px-2 py-1 text-xs rounded-full ${getPermissionBadgeClass(perm.permission_type)}">
                                    ${perm.permission_display}
                                </span>
                                ${perm.is_expired ? '<span class="ml-2 text-xs text-red-600">Expired</span>' : ''}
                            </div>
                            <button onclick="revokePermission(${perm.id}, '${perm.user_name}', '${bank.name}')" 
                                    class="text-red-600 hover:text-red-800 text-sm">
                                Revoke
                            </button>
                        </div>
                    `).join('')
                }
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

function getPermissionBadgeClass(permissionType) {
    switch(permissionType) {
        case 'view': return 'bg-blue-100 text-blue-800';
        case 'edit': return 'bg-green-100 text-green-800';
        case 'copy': return 'bg-yellow-100 text-yellow-800';
        case 'full': return 'bg-purple-100 text-purple-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function showAddPermissionForm(bankId, bankName) {
    const formHTML = `
        <div id="addPermissionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60">
            <div class="relative top-20 mx-auto p-5 border max-w-md shadow-lg rounded-md bg-white">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Add Permission</h3>
                    <button onclick="closeAddPermissionForm()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <p class="text-sm text-gray-600 mb-4">Grant access to: <strong>${bankName}</strong></p>
                
                <form id="addPermissionForm" class="space-y-4">
                    <input type="hidden" id="selectedBankId" value="${bankId}">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Teacher</label>
                        <select id="teacherSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Loading teachers...</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Permission Type</label>
                        <select id="permissionTypeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="view">View Only</option>
                            <option value="edit">View & Edit</option>
                            <option value="copy">View & Copy Questions</option>
                            <option value="full">Full Access</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Expiration Date (Optional)</label>
                        <input type="date" id="expirationDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                        <textarea id="permissionNotes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Add any notes about this permission..."></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="closeAddPermissionForm()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Grant Permission
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', formHTML);
    loadTeachersForSelect();
    
    // Handle form submission
    document.getElementById('addPermissionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitPermission();
    });
}

function loadTeachersForSelect() {
    fetch('/users/admin/api/teachers/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('teacherSelect');
            select.innerHTML = '<option value="">Select a teacher...</option>' +
                data.teachers.map(teacher => 
                    `<option value="${teacher.id}">${teacher.display_name}</option>`
                ).join('');
        })
        .catch(error => {
            console.error('Error loading teachers:', error);
        });
}

function submitPermission() {
    const formData = new FormData();
    formData.append('question_bank_id', document.getElementById('selectedBankId').value);
    formData.append('user_id', document.getElementById('teacherSelect').value);
    formData.append('permission_type', document.getElementById('permissionTypeSelect').value);
    formData.append('expires_at', document.getElementById('expirationDate').value);
    formData.append('notes', document.getElementById('permissionNotes').value);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('/users/admin/api/question-bank-permissions/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            closeAddPermissionForm();
            loadQuestionBankPermissions(); // Refresh the list
        } else {
            alert(data.error || 'Error granting permission');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error granting permission');
    });
}

function revokePermission(permissionId, userName, bankName) {
    if (confirm(`Revoke ${userName}'s access to "${bankName}"?`)) {
        fetch(`/users/admin/api/question-bank-permissions/?permission_id=${permissionId}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                loadQuestionBankPermissions(); // Refresh the list
            } else {
                alert(data.error || 'Error revoking permission');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error revoking permission');
        });
    }
}

function updatePermissionSummary(banks) {
    const privateBanks = banks.filter(bank => !bank.is_public).length;
    const banksWithPermissions = banks.filter(bank => bank.permission_count > 0).length;
    const totalPermissions = banks.reduce((sum, bank) => sum + bank.permission_count, 0);
    
    document.getElementById('private-banks-count').textContent = privateBanks;
    document.getElementById('banks-with-permissions').textContent = banksWithPermissions;
    document.getElementById('total-permissions').textContent = totalPermissions;
}

function closePermissionManager() {
    const modal = document.getElementById('permissionManagerModal');
    if (modal) modal.remove();
}

function closeAddPermissionForm() {
    const modal = document.getElementById('addPermissionModal');
    if (modal) modal.remove();
}

function closeBulkPermissionModal() {
    const modal = document.getElementById('bulkPermissionModal');
    if (modal) modal.remove();
}

// Document Management Functions
function openDocumentViewer() {
    fetch('/pdf-extractor/api/admin/documents/')
        .then(response => response.json())
        .then(data => {
            showDocumentListModal(data);
        })
        .catch(error => {
            console.error('Error loading documents:', error);
            alert('Error loading documents');
        });
}

function showDocumentListModal(documents) {
    // Check if documents is an array, if not it's likely an error response
    if (!Array.isArray(documents)) {
        console.error('Invalid documents response:', documents);
        alert('Error: Unable to load documents. Please check your permissions.');
        return;
    }
    
    const modal = document.createElement('div');
    modal.id = 'documentViewerModal';
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
    modal.innerHTML = `
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">All Documents</h3>
                <button onclick="closeModal('documentViewerModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="max-h-96 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Questions</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${documents.length > 0 ? documents.map(doc => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${doc.title || doc.filename}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.user}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs rounded-full ${doc.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${doc.status}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.question_count || 0}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <a href="/pdf-extractor/document/${doc.id}/" class="text-blue-600 hover:text-blue-900 mr-2">View</a>
                                    <button onclick="deleteDocument('${doc.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                                </td>
                            </tr>
                        `).join('') : '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No documents found</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function openProcessingMonitor() {
    fetch('/pdf-extractor/api/admin/processing-status/')
        .then(response => response.json())
        .then(data => {
            showProcessingMonitorModal(data);
        })
        .catch(error => {
            console.error('Error loading processing status:', error);
        });
}

function showProcessingMonitorModal(data) {
    const modal = document.createElement('div');
    modal.id = 'processingMonitorModal';
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
    modal.innerHTML = `
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Processing Monitor</h3>
                <button onclick="closeModal('processingMonitorModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-medium text-blue-900">Processing Queue</h4>
                    <p class="text-sm text-blue-700">${data.in_progress || 0} documents currently processing</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <h4 class="font-medium text-green-900">Success Rate</h4>
                    <p class="text-sm text-green-700">${data.success_rate || 0}% successful extractions</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <h4 class="font-medium text-yellow-900">Average Processing Time</h4>
                    <p class="text-sm text-yellow-700">${data.avg_time || 0} minutes per document</p>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function openDocumentCleanup() {
    const modal = document.createElement('div');
    modal.id = 'documentCleanupModal';
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
    modal.innerHTML = `
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Document Cleanup & Maintenance</h3>
                <button onclick="closeModal('documentCleanupModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <button onclick="cleanupFailedDocuments()" class="w-full flex items-center justify-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Clean Failed Documents
                </button>
                <button onclick="cleanupOldDocuments()" class="w-full flex items-center justify-center px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Archive Old Documents (>90 days)
                </button>
                <button onclick="optimizeDatabase()" class="w-full flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Optimize Database
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function openBulkOperations() {
    const modal = document.createElement('div');
    modal.id = 'bulkOperationsModal';
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
    modal.innerHTML = `
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Bulk Operations</h3>
                <button onclick="closeModal('bulkOperationsModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <button onclick="bulkUpdateMetadata()" class="w-full flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Bulk Update Metadata
                </button>
                <button onclick="bulkExportDocuments()" class="w-full flex items-center justify-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export Documents & Questions
                </button>
                <button onclick="bulkReprocess()" class="w-full flex items-center justify-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Reprocess Failed Documents
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function openDocumentAnalytics() {
    fetch('/pdf-extractor/api/admin/analytics/')
        .then(response => response.json())
        .then(data => {
            showAnalyticsModal(data);
        })
        .catch(error => {
            console.error('Error loading analytics:', error);
        });
}

function showAnalyticsModal(data) {
    const modal = document.createElement('div');
    modal.id = 'analyticsModal';
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
    modal.innerHTML = `
        <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Document Analytics</h3>
                <button onclick="closeModal('analyticsModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-medium text-blue-900">Upload Trends</h4>
                    <p class="text-2xl font-bold text-blue-800">${data.uploads_this_month || 0}</p>
                    <p class="text-sm text-blue-600">Documents this month</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <h4 class="font-medium text-green-900">Extraction Success</h4>
                    <p class="text-2xl font-bold text-green-800">${data.success_rate || 0}%</p>
                    <p class="text-sm text-green-600">Success rate</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <h4 class="font-medium text-yellow-900">Popular Exam Types</h4>
                    <ul class="text-sm text-yellow-700">
                        ${(data.popular_exam_types || []).map(type => `<li>${type.name}: ${type.count}</li>`).join('')}
                    </ul>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h4 class="font-medium text-purple-900">Active Users</h4>
                    <p class="text-2xl font-bold text-purple-800">${data.active_users || 0}</p>
                    <p class="text-sm text-purple-600">Users this week</p>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function openExtractionReport() {
    window.open('/pdf-extractor/api/admin/extraction-report/', '_blank');
}

function openUserActivityReport() {
    window.open('/pdf-extractor/api/admin/user-activity-report/', '_blank');
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.remove();
}

function deleteDocument(documentId) {
    if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
        fetch(`/pdf-extractor/api/delete-document/${documentId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Document deleted successfully');
                location.reload();
            } else {
                alert('Error deleting document: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting document');
        });
    }
}

// Load document statistics when documents section is opened
function loadDocumentStats() {
    fetch('/pdf-extractor/api/admin/document-stats/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-documents').textContent = data.total || 0;
            document.getElementById('processed-documents').textContent = data.processed || 0;
            document.getElementById('in-progress-documents').textContent = data.in_progress || 0;
            document.getElementById('extracted-questions').textContent = data.questions || 0;
            document.getElementById('avg-processing-time').textContent = (data.avg_time || 0) + ' min';
            document.getElementById('extraction-success-rate').textContent = (data.success_rate || 0) + '%';
        })
        .catch(error => {
            console.error('Error loading document stats:', error);
        });
    
    // Load recent activity
    fetch('/pdf-extractor/api/admin/recent-activity/')
        .then(response => response.json())
        .then(data => {
            const activityList = document.getElementById('document-activity-list');
            activityList.innerHTML = '';
            (data.activities || []).forEach(activity => {
                const li = document.createElement('li');
                li.className = 'py-3';
                li.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <div class="h-8 w-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-gray-900">${activity.description}</p>
                            <p class="text-xs text-gray-500">${activity.timestamp}</p>
                        </div>
                    </div>
                `;
                activityList.appendChild(li);
            });
        })
        .catch(error => {
            console.error('Error loading recent activity:', error);
        });
}

// Load permission summary on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load permission summary
    fetch('/users/admin/api/question-bank-permissions/')
        .then(response => response.json())
        .then(data => {
            updatePermissionSummary(data.question_banks);
        })
        .catch(error => {
            console.error('Error loading permission summary:', error);
        });
});

// Global Topic Taxonomy Management Functions
function showCreateSubjectModal() {
    // This would show a modal to create a new subject
    alert('Create Subject Modal\n\nThis will open a form to create new subjects with:\n Subject name and code\n Category and level\n Description and icon\n Learning standards alignment');
}

function viewAllSubjects() {
    // Open a modal or new page to view all subjects
    window.open('/knowledge/topics/', '_blank');
}

function manageSubjectCategories() {
    // This would show a modal to manage subject categories
    alert('Manage Categories\n\nThis will allow you to:\n Add new subject categories\n Edit existing categories\n Set category hierarchies\n Configure category-specific settings');
}

function showCreateTopicModal() {
    // This would show a modal to create a new topic
    alert('Create Topic Modal\n\nThis will open a comprehensive form to create topics with:\n Title and description\n Parent topic selection\n Difficulty and priority levels\n Learning objectives\n Prerequisites and dependencies');
}

function viewPendingApprovals() {
    // Show topics pending approval
    alert('Pending Approvals\n\nThis will show all topics and subjects waiting for admin approval.\n\nYou can:\n Review content quality\n Approve or reject submissions\n Provide feedback to creators\n Set approval workflows');
}

function manageTopicHierarchy() {
    // Show hierarchical view of topics
    alert('Topic Hierarchy Manager\n\nThis will provide a drag-and-drop interface to:\n Reorganize topic structures\n Move topics between subjects\n Set parent-child relationships\n Bulk operations on topics');
}

function showCreateTemplateModal() {
    // Show modal to create curriculum templates
    alert('Create Template Modal\n\nThis will allow you to:\n Create curriculum templates\n Select topics for the template\n Set import rules and filters\n Configure template visibility');
}

function viewAllTemplates() {
    // Show all available templates
    window.open('/knowledge/exam-selector/', '_blank');
}

function importFromTemplate() {
    // Show template import interface
    alert('Import from Template\n\nThis will provide options to:\n Select existing templates\n Customize import settings\n Map topics to exam syllabi\n Bulk import curriculum structures');
}

// Load taxonomy statistics and data
function loadTaxonomyData() {
    fetch('/knowledge/api/admin/stats/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalSubjects').textContent = data.stats.total_subjects;
                document.getElementById('totalTopics').textContent = data.stats.total_topics;
                document.getElementById('totalTemplates').textContent = data.stats.total_templates;
                document.getElementById('pendingApproval').textContent = data.stats.pending_approval;
                
                // Load popular subjects and topics
                loadPopularContent(data.popular_subjects, data.popular_topics);
            }
        })
        .catch(error => {
            console.error('Error loading taxonomy data:', error);
        });
}

function loadPopularContent(subjects, topics) {
    // Load popular subjects
    const popularSubjectsDiv = document.getElementById('popularSubjects');
    if (subjects && subjects.length > 0) {
        popularSubjectsDiv.innerHTML = subjects.map(subject => `
            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                <span class="text-sm font-medium">${subject.name}</span>
                <span class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded">${subject.popularity_score} uses</span>
            </div>
        `).join('');
    } else {
        popularSubjectsDiv.innerHTML = '<div class="text-sm text-gray-500">No data available</div>';
    }
    
    // Load popular topics
    const popularTopicsDiv = document.getElementById('popularTopics');
    if (topics && topics.length > 0) {
        popularTopicsDiv.innerHTML = topics.map(topic => `
            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                <span class="text-sm font-medium">${topic.title}</span>
                <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded">${topic.usage_count} uses</span>
            </div>
        `).join('');
    } else {
        popularTopicsDiv.innerHTML = '<div class="text-sm text-gray-500">No data available</div>';
    }
}

// Load taxonomy data when taxonomy section is opened - integrated into existing adminDashboard function

// ========================================
// Test Attempts Management Functions
// ========================================

let allTests = [];
let filteredTests = [];

function openTestAttemptsModal() {
    const modal = document.getElementById('testAttemptsModal');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Load tests
    loadTestsData();
}

function closeTestAttemptsModal() {
    const modal = document.getElementById('testAttemptsModal');
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function loadTestsData() {
    const loadingDiv = document.getElementById('testAttemptsLoading');
    const tableDiv = document.getElementById('testAttemptsTable');
    const emptyDiv = document.getElementById('testAttemptsEmpty');

    // Show loading state
    loadingDiv.classList.remove('hidden');
    tableDiv.classList.add('hidden');
    emptyDiv.classList.add('hidden');

    // Fetch tests from API
    fetch('{% url "test-attempts-list-api" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allTests = data.tests;
                filteredTests = [...allTests];
                renderTestsTable();

                // Hide loading, show table
                loadingDiv.classList.add('hidden');
                if (filteredTests.length > 0) {
                    tableDiv.classList.remove('hidden');
                } else {
                    emptyDiv.classList.remove('hidden');
                }
            } else {
                console.error('Failed to load tests:', data);
                loadingDiv.classList.add('hidden');
                emptyDiv.classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error loading tests:', error);
            loadingDiv.classList.add('hidden');
            emptyDiv.classList.remove('hidden');
            alert('Error loading tests. Please try again.');
        });
}

function renderTestsTable() {
    const tbody = document.getElementById('testAttemptsTableBody');
    tbody.innerHTML = '';

    filteredTests.forEach(test => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-3 py-4 whitespace-nowrap">
                <input type="checkbox" class="test-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                       data-test-id="${test.id}" value="${test.id}">
            </td>
            <td class="px-6 py-4">
                <div class="text-sm font-medium text-gray-900">${test.title}</div>
                <div class="text-xs text-gray-500">${test.is_published ? '<span class="text-green-600">Published</span>' : '<span class="text-yellow-600">Draft</span>'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${test.exam_name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${test.duration_minutes} min</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${test.total_marks}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                    ${test.max_attempts}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                    ${test.total_attempts}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" min="1" max="999"
                       class="w-20 px-2 py-1 border border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500"
                       value="${test.max_attempts}"
                       id="attempts-${test.id}">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="updateSingleTest('${test.id}')"
                        class="text-indigo-600 hover:text-indigo-900 mr-2">
                    Update
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function searchTests() {
    const searchInput = document.getElementById('testSearchInput').value.toLowerCase();

    filteredTests = allTests.filter(test => {
        return test.title.toLowerCase().includes(searchInput) ||
               test.exam_name.toLowerCase().includes(searchInput);
    });

    renderTestsTable();

    // Update empty state
    const tableDiv = document.getElementById('testAttemptsTable');
    const emptyDiv = document.getElementById('testAttemptsEmpty');

    if (filteredTests.length > 0) {
        tableDiv.classList.remove('hidden');
        emptyDiv.classList.add('hidden');
    } else {
        tableDiv.classList.add('hidden');
        emptyDiv.classList.remove('hidden');
    }
}

function toggleAllTests(checkbox) {
    const checkboxes = document.querySelectorAll('.test-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
}

function updateSingleTest(testId) {
    const attemptsInput = document.getElementById(`attempts-${testId}`);
    const maxAttempts = parseInt(attemptsInput.value);

    if (!maxAttempts || maxAttempts < 1) {
        alert('Please enter a valid number of attempts (minimum 1)');
        return;
    }

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('{% url "update-test-max-attempts-api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            test_id: testId,
            max_attempts: maxAttempts
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // Reload the table
            loadTestsData();
        } else {
            alert('Error: ' + (data.error || 'Failed to update test attempts'));
        }
    })
    .catch(error => {
        console.error('Error updating test:', error);
        alert('Error updating test attempts. Please try again.');
    });
}

function bulkUpdateAttempts() {
    const selectedCheckboxes = document.querySelectorAll('.test-checkbox:checked');
    const bulkMaxAttempts = document.getElementById('bulkMaxAttempts').value;

    if (selectedCheckboxes.length === 0) {
        alert('Please select at least one test');
        return;
    }

    if (!bulkMaxAttempts) {
        alert('Please select a max attempts value');
        return;
    }

    const testIds = Array.from(selectedCheckboxes).map(cb => cb.value);

    if (!confirm(`Update ${testIds.length} test(s) to ${bulkMaxAttempts} max attempts?`)) {
        return;
    }

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('{% url "bulk-update-test-attempts-api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            test_ids: testIds,
            max_attempts: parseInt(bulkMaxAttempts)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // Reset bulk select
            document.getElementById('bulkMaxAttempts').value = '';
            document.getElementById('selectAllTests').checked = false;
            // Reload the table
            loadTestsData();
        } else {
            alert('Error: ' + (data.error || 'Failed to update test attempts'));
        }
    })
    .catch(error => {
        console.error('Error updating tests:', error);
        alert('Error updating test attempts. Please try again.');
    });
}
</script>
{% endblock %}