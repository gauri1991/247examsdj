{% extends 'base/base.html' %}

{% block title %}Create Question - {{ question_bank.name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb Navigation -->
    <nav class="flex items-center text-sm text-gray-600 mb-6">
        <a href="{% url 'question-bank' %}" class="text-blue-600 hover:text-blue-800 transition-colors duration-150">Question Banks</a>
        <span class="mx-2 text-gray-400">/</span>
        <a href="{% url 'question-bank-detail' question_bank.id %}" class="text-blue-600 hover:text-blue-800 transition-colors duration-150">{{ question_bank.name|truncatechars:20 }}</a>
        <span class="mx-2 text-gray-400">/</span>
        <span class="text-gray-900 font-medium">Create Question</span>
    </nav>

    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex items-center">
            <a href="{% url 'question-bank-detail' question_bank.id %}" class="mr-4 text-gray-400 hover:text-gray-600 transition-colors duration-150 focus-ring rounded">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
            </a>
            <div>
                <h1 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">Create New Question</h1>
                <p class="mt-1 text-sm text-gray-500">Add a question to {{ question_bank.name }}</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-5xl">
        <form method="POST" enctype="multipart/form-data" class="space-y-8">
            {% csrf_token %}
            
            
            <!-- Question Type Selection -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Question Type</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                    <label class="relative cursor-pointer rounded-lg border border-gray-300 bg-white p-4 shadow-sm focus:outline-none hover:border-gray-400 transition-colors duration-150" for="type_mcq">
                        <input type="radio" name="question_type" value="mcq" id="type_mcq" class="sr-only" checked>
                        <div class="mx-auto mb-3 h-10 w-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="text-center">
                            <div class="font-medium text-gray-900">Multiple Choice</div>
                            <div class="text-sm text-gray-500">Single correct answer</div>
                        </div>
                    </label>
                    
                    <label class="relative cursor-pointer rounded-lg border border-gray-300 bg-white p-4 shadow-sm focus:outline-none hover:border-gray-400 transition-colors duration-150" for="type_multi_select">
                        <input type="radio" name="question_type" value="multi_select" id="type_multi_select" class="sr-only">
                        <div class="mx-auto mb-3 h-10 w-10 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="text-center">
                            <div class="font-medium text-gray-900">Multi-Select</div>
                            <div class="text-sm text-gray-500">Multiple correct answers</div>
                        </div>
                    </label>
                    
                    <label class="relative cursor-pointer rounded-lg border border-gray-300 bg-white p-4 shadow-sm focus:outline-none hover:border-gray-400 transition-colors duration-150" for="type_true_false">
                        <input type="radio" name="question_type" value="true_false" id="type_true_false" class="sr-only">
                        <div class="mx-auto mb-3 h-10 w-10 rounded-lg bg-green-100 text-green-600 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="text-center">
                            <div class="font-medium text-gray-900">True/False</div>
                            <div class="text-sm text-gray-500">Binary choice</div>
                        </div>
                    </label>
                    
                    <label class="relative cursor-pointer rounded-lg border border-gray-300 bg-white p-4 shadow-sm focus:outline-none hover:border-gray-400 transition-colors duration-150" for="type_fill_blank">
                        <input type="radio" name="question_type" value="fill_blank" id="type_fill_blank" class="sr-only">
                        <div class="mx-auto mb-3 h-10 w-10 rounded-lg bg-yellow-100 text-yellow-600 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="text-center">
                            <div class="font-medium text-gray-900">Fill in the Blank</div>
                            <div class="text-sm text-gray-500">Text input answer</div>
                        </div>
                    </label>
                    
                    <label class="relative cursor-pointer rounded-lg border border-gray-300 bg-white p-4 shadow-sm focus:outline-none hover:border-gray-400 transition-colors duration-150" for="type_essay">
                        <input type="radio" name="question_type" value="essay" id="type_essay" class="sr-only">
                        <div class="mx-auto mb-3 h-10 w-10 rounded-lg bg-red-100 text-red-600 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="text-center">
                            <div class="font-medium text-gray-900">Essay</div>
                            <div class="text-sm text-gray-500">Long-form response</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Basic Question Information -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Question Details</h3>
                
                <div class="space-y-6">
                    <!-- Question Text -->
                    <div>
                        <label for="question_text" class="block text-sm font-medium text-gray-700 mb-1">Question Text <span class="text-red-500">*</span></label>
                        <div class="mt-1">
                            <div id="question-editor" class="border border-gray-300 rounded-md"></div>
                        </div>
                        <textarea name="question_text" id="question_text" class="hidden" required></textarea>
                        <p class="mt-1 text-sm text-gray-500">Enter your question text. Use the toolbar above for rich formatting.</p>
                    </div>
                    
                    <!-- Question Image -->
                    <div>
                        <label for="image" class="block text-sm font-medium text-gray-700 mb-1">Question Image</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-gray-400 transition-colors duration-150">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="flex text-sm text-gray-600">
                                    <label for="image" class="relative cursor-pointer bg-white rounded-md font-medium text-primary-600 hover:text-primary-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary-500">
                                        <span>Upload an image</span>
                                        <input id="image" name="image" type="file" accept="image/*" class="sr-only">
                                    </label>
                                    <p class="pl-1">or drag and drop</p>
                                </div>
                                <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Question Options Section (Dynamic based on type) -->
            <div id="options-section" class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Answer Options</h3>
                
                <!-- True/False Options -->
                <div id="true-false-options" class="hidden space-y-4">
                    <p class="text-sm text-gray-600 mb-4">Select the correct answer</p>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="radio" name="correct_answer" value="true" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 mr-3">
                            <span class="text-sm font-medium text-gray-900">True</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="correct_answer" value="false" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 mr-3">
                            <span class="text-sm font-medium text-gray-900">False</span>
                        </label>
                    </div>
                </div>
                
                <!-- MCQ/Multi-Select Options -->
                <div id="mcq-options" class="space-y-4">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-sm text-gray-600">Add answer options for your question</p>
                        <button type="button" id="add-option" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add Option
                        </button>
                    </div>
                    
                    <div id="options-container">
                        <!-- Options will be dynamically added here -->
                    </div>
                </div>
            </div>
            
                <!-- Fill in the Blank Options -->
                <div id="fill-blank-options" class="hidden space-y-4">
                    <div>
                        <label for="correct_answers" class="block text-sm font-medium text-gray-700 mb-1">Correct Answers <span class="text-red-500">*</span></label>
                        <textarea name="correct_answers" id="correct_answers" rows="3" 
                                  placeholder="Enter correct answers, one per line. Multiple acceptable answers can be provided."
                                  class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                        <p class="mt-1 text-sm text-gray-500">Enter all acceptable answers, one per line. Case sensitivity can be configured below.</p>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" name="case_sensitive" id="case_sensitive" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-3">
                        <label for="case_sensitive" class="text-sm text-gray-700">Case sensitive answers</label>
                    </div>
                </div>
            
                <!-- Essay Requirements -->
                <div id="essay-options" class="hidden space-y-4">
                    <p class="text-sm text-gray-600 mb-4">Set requirements for essay responses</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="min_words" class="block text-sm font-medium text-gray-700 mb-1">Minimum Words</label>
                            <input type="number" name="min_words" id="min_words" min="0" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <p class="mt-1 text-sm text-gray-500">Minimum word count required</p>
                        </div>
                        <div>
                            <label for="max_words" class="block text-sm font-medium text-gray-700 mb-1">Maximum Words</label>
                            <input type="number" name="max_words" id="max_words" min="0" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <p class="mt-1 text-sm text-gray-500">Maximum word count allowed</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Question Settings -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Question Settings</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Topic & Subtopic -->
                    <div>
                        <label for="topic" class="block text-sm font-medium text-gray-700 mb-1">Topic</label>
                        <input type="text" name="topic" id="topic" 
                               placeholder="e.g., Algebra, Geometry"
                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <p class="mt-1 text-sm text-gray-500">Main topic or subject area</p>
                    </div>
                    
                    <div>
                        <label for="subtopic" class="block text-sm font-medium text-gray-700 mb-1">Subtopic</label>
                        <input type="text" name="subtopic" id="subtopic" 
                               placeholder="e.g., Linear Equations, Quadratic Functions"
                               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <p class="mt-1 text-sm text-gray-500">Specific subtopic within the main topic</p>
                    </div>
                    
                    <!-- Difficulty Level -->
                    <div>
                        <label for="difficulty" class="block text-sm font-medium text-gray-700 mb-1">Difficulty Level</label>
                        <select name="difficulty" id="difficulty" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="easy" {% if question_bank.default_difficulty == 'easy' %}selected{% endif %}>ðŸŸ¢ Easy</option>
                            <option value="medium" {% if question_bank.default_difficulty == 'medium' or not question_bank.default_difficulty %}selected{% endif %}>ðŸŸ¡ Medium</option>
                            <option value="hard" {% if question_bank.default_difficulty == 'hard' %}selected{% endif %}>ðŸ”´ Hard</option>
                            <option value="expert" {% if question_bank.default_difficulty == 'expert' %}selected{% endif %}>ðŸŸ£ Expert</option>
                        </select>
                        <p class="mt-1 text-sm text-gray-500">How challenging is this question?</p>
                    </div>
                    
                    <!-- Marks -->
                    <div>
                        <label for="marks" class="block text-sm font-medium text-gray-700 mb-1">Marks/Points</label>
                        <div class="relative">
                            <input type="number" name="marks" id="marks" 
                                   value="{{ question_bank.default_marks|default:1 }}"
                                   min="0.5" step="0.5"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm pr-16">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 text-sm">points</span>
                            </div>
                        </div>
                        <p class="mt-1 text-sm text-gray-500">Points awarded for correct answer</p>
                    </div>
                    
                    <!-- Time Limit -->
                    <div>
                        <label for="time_limit" class="block text-sm font-medium text-gray-700 mb-1">Time Limit</label>
                        <div class="relative">
                            <input type="number" name="time_limit" id="time_limit" 
                                   min="10" step="10"
                                   placeholder="120"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm pr-20">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 text-sm">seconds</span>
                            </div>
                        </div>
                        <p class="mt-1 text-sm text-gray-500">Optional time limit for answering (leave blank for no limit)</p>
                    </div>
                </div>
            </div>
            
            
            <!-- Explanation Section -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Explanation (Optional)</h3>
                
                <div>
                    <label for="explanation" class="block text-sm font-medium text-gray-700 mb-1">Answer Explanation</label>
                    <div class="mt-1">
                        <div id="explanation-editor" class="border border-gray-300 rounded-md"></div>
                    </div>
                    <textarea name="explanation" id="explanation" class="hidden"></textarea>
                    <p class="mt-1 text-sm text-gray-500">Provide an explanation that will be shown after the question is answered</p>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3 pt-8 border-t border-gray-200">
                <a href="{% url 'question-bank-detail' question_bank.id %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 text-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    Cancel
                </a>
                <button type="button" id="preview-btn" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    Preview Question
                </button>
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Create Question
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-full overflow-y-auto">
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Question Preview</h3>
            <button onclick="closePreviewModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 rounded-md p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div id="previewContent" class="p-6 space-y-4">
            <!-- Preview content will be generated here -->
        </div>
        
        <div class="flex justify-end p-6 pt-4 border-t border-gray-200">
            <button onclick="closePreviewModal()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Close Preview</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- Include Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<style>
/* Question type selection styling */
.question-type-option input:checked + div {
    background-color: rgb(219 234 254);
    color: rgb(37 99 235);
}

.question-type-option input:checked ~ div {
    color: rgb(17 24 39);
}

.question-type-option.selected {
    border-color: rgb(59 130 246);
    background-color: rgb(239 246 255);
}

/* Rich text editor enhancements */
.ql-toolbar {
    border-top: 1px solid rgb(209 213 219);
    border-left: 1px solid rgb(209 213 219);
    border-right: 1px solid rgb(209 213 219);
    background-color: rgb(249 250 251);
}

.ql-container {
    border-bottom: 1px solid rgb(209 213 219);
    border-left: 1px solid rgb(209 213 219);
    border-right: 1px solid rgb(209 213 219);
}

.ql-editor {
    min-height: 120px;
}

/* Option styling */
.option-item {
    display: flex;
    align-items: flex-start;
    column-gap: 0.75rem;
    padding: 1rem;
    border: 1px solid rgb(229 231 235);
    border-radius: 0.5rem;
}

.option-item.correct {
    border-color: rgb(134 239 172);
    background-color: rgb(240 253 244);
}

/* Drag and drop styling */
.drag-over {
    border-color: rgb(96 165 250);
    background-color: rgb(239 246 255);
}

/* Form classes for JavaScript compatibility */
.form-radio { 
    height: 1rem; 
    width: 1rem; 
    color: rgb(37 99 235); 
    border-color: rgb(209 213 219); 
}

.form-checkbox { 
    height: 1rem; 
    width: 1rem; 
    color: rgb(37 99 235); 
    border-color: rgb(209 213 219); 
    border-radius: 0.25rem; 
}

.form-input {
    display: block;
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid rgb(209 213 219);
    border-radius: 0.375rem;
    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    font-size: 0.875rem;
    line-height: 1.25rem;
}

.form-input:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
    border-color: rgb(59 130 246);
    box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
}

.badge {
    display: inline-flex;
    align-items: center;
    padding: 0.125rem 0.625rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge-mcq { background-color: rgb(219 234 254); color: rgb(30 64 175); }
.badge-multi-select { background-color: rgb(233 213 255); color: rgb(107 33 168); }
.badge-true-false { background-color: rgb(220 252 231); color: rgb(20 83 45); }
.badge-fill-blank { background-color: rgb(254 249 195); color: rgb(133 77 14); }
.badge-essay { background-color: rgb(254 226 226); color: rgb(153 27 27); }
.badge-success { background-color: rgb(220 252 231); color: rgb(20 83 45); }
.badge-warning { background-color: rgb(254 249 195); color: rgb(133 77 14); }
.badge-danger { background-color: rgb(254 226 226); color: rgb(153 27 27); }
.badge-info { background-color: rgb(219 234 254); color: rgb(30 64 175); }
.badge-secondary { background-color: rgb(243 244 246); color: rgb(55 65 81); }
</style>

{% endblock %}

{% block extra_js %}
<!-- Include Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if Quill is loaded
    if (typeof Quill === 'undefined') {
        console.error('Quill editor library not loaded');
        return;
    }
    
    // Initialize Quill editors
    const questionEditor = new Quill('#question-editor', {
        theme: 'snow',
        placeholder: 'Enter your question text here...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'script': 'sub'}, { 'script': 'super' }],
                ['link', 'formula'],
                ['clean']
            ]
        }
    });
    
    const explanationEditor = new Quill('#explanation-editor', {
        theme: 'snow',
        placeholder: 'Enter explanation for this question...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link'],
                ['clean']
            ]
        }
    });
    
    // Question type selection
    const questionTypeInputs = document.querySelectorAll('input[name="question_type"]');
    const optionsSection = document.getElementById('options-section');
    const mcqOptions = document.getElementById('mcq-options');
    const trueFalseOptions = document.getElementById('true-false-options');
    const fillBlankOptions = document.getElementById('fill-blank-options');
    const essayOptions = document.getElementById('essay-options');
    
    // Check if all required elements exist
    if (!mcqOptions || !trueFalseOptions || !fillBlankOptions || !essayOptions) {
        console.error('Some question option sections are missing from the DOM');
        return;
    }
    
    let optionCount = 0;
    
    function updateQuestionType(type) {
        // Hide all option sections
        mcqOptions.classList.add('hidden');
        trueFalseOptions.classList.add('hidden');
        fillBlankOptions.classList.add('hidden');
        essayOptions.classList.add('hidden');
        
        // Show relevant section
        switch(type) {
            case 'mcq':
            case 'multi_select':
                mcqOptions.classList.remove('hidden');
                if (optionCount === 0) {
                    addOption();
                    addOption();
                }
                break;
            case 'true_false':
                trueFalseOptions.classList.remove('hidden');
                break;
            case 'fill_blank':
                fillBlankOptions.classList.remove('hidden');
                break;
            case 'essay':
                essayOptions.classList.remove('hidden');
                break;
        }
        
        // Update visual selection
        questionTypeInputs.forEach(input => {
            const option = input.closest('label');
            if (input.checked) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
        });
    }
    
    function addOption() {
        optionCount++;
        const container = document.getElementById('options-container');
        const currentType = document.querySelector('input[name="question_type"]:checked').value;
        const isMultiSelect = currentType === 'multi_select';
        
        const optionHtml = `
            <div class="option-item" data-option="${optionCount}">
                <div class="flex-shrink-0 mt-1">
                    <input type="${isMultiSelect ? 'checkbox' : 'radio'}" 
                           name="correct_option${isMultiSelect ? '[]' : ''}" 
                           value="${optionCount}" 
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300${isMultiSelect ? ' rounded' : ''}">
                </div>
                <div class="flex-1">
                    <input type="text" 
                           name="option_${optionCount}" 
                           placeholder="Enter option text..."
                           class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           required>
                </div>
                <div class="flex-shrink-0">
                    <button type="button" onclick="removeOption(${optionCount})" 
                            class="text-red-600 hover:text-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 rounded p-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', optionHtml);
    }
    
    window.removeOption = function(optionNum) {
        const option = document.querySelector(`[data-option="${optionNum}"]`);
        if (option) {
            option.remove();
        }
    };
    
    // Event listeners
    questionTypeInputs.forEach(input => {
        input.addEventListener('change', (e) => {
            updateQuestionType(e.target.value);
        });
    });
    
    const addOptionBtn = document.getElementById('add-option');
    if (addOptionBtn) {
        addOptionBtn.addEventListener('click', addOption);
    } else {
        console.error('Add option button not found');
    }
    
    // Form submission
    document.querySelector('form').addEventListener('submit', function(e) {
        // Validate question text
        const questionContent = questionEditor.root.innerHTML.trim();
        if (questionContent === '<p><br></p>' || questionContent === '' || questionContent === '<p></p>') {
            e.preventDefault();
            alert('Please enter a question text.');
            return false;
        }
        
        // Validate question type specific requirements
        const questionType = document.querySelector('input[name="question_type"]:checked').value;
        if (questionType === 'mcq' || questionType === 'multi_select') {
            const options = document.querySelectorAll('[name^="option_"]');
            if (options.length < 2) {
                e.preventDefault();
                alert('Please add at least 2 options for multiple choice questions.');
                return false;
            }
        }
        
        // Update hidden textareas with editor content
        document.getElementById('question_text').value = questionEditor.root.innerHTML;
        document.getElementById('explanation').value = explanationEditor.root.innerHTML;
    });
    
    // Initialize with MCQ selected
    updateQuestionType('mcq');
    
    // Preview and modal functionality
    const previewBtn = document.getElementById('preview-btn');
    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
            generatePreview();
        });
    } else {
        console.error('Preview button not found');
    }
    
    function generatePreview() {
        try {
            const questionText = questionEditor.root.innerHTML;
            const questionType = document.querySelector('input[name="question_type"]:checked').value;
            const difficulty = document.getElementById('difficulty').value || 'medium';
            const marks = document.getElementById('marks').value || '1';
            const timeLimit = document.getElementById('time_limit').value;
        
        let previewHtml = `
            <div class="space-y-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="badge badge-${questionType.replace('_', '-')}">${getQuestionTypeLabel(questionType)}</span>
                        <span class="badge badge-${difficulty === 'easy' ? 'success' : difficulty === 'medium' ? 'warning' : 'danger'}">${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}</span>
                        <span class="badge badge-secondary">${marks} point${marks > 1 ? 's' : ''}</span>
                        ${timeLimit ? `<span class="badge badge-info">${timeLimit}s</span>` : ''}
                    </div>
                </div>
                
                <div class="prose max-w-none">
                    ${questionText}
                </div>
        `;
        
        // Add options based on question type
        if (questionType === 'mcq' || questionType === 'multi_select') {
            const options = document.querySelectorAll('[name^="option_"]');
            if (options.length > 0) {
                previewHtml += '<div class="space-y-2 mt-4"><h4 class="font-medium text-gray-900">Options:</h4>';
                options.forEach((option, index) => {
                    if (option.value.trim()) {
                        previewHtml += `
                            <div class="flex items-center space-x-3">
                                <span class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center text-sm font-medium">
                                    ${String.fromCharCode(65 + index)}
                                </span>
                                <span>${option.value}</span>
                            </div>
                        `;
                    }
                });
                previewHtml += '</div>';
            }
        } else if (questionType === 'true_false') {
            previewHtml += `
                <div class="space-y-2 mt-4">
                    <h4 class="font-medium text-gray-900">Options:</h4>
                    <div class="flex space-x-6">
                        <label class="flex items-center">
                            <input type="radio" name="preview_tf" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 mr-2" disabled>
                            <span>True</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="preview_tf" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 mr-2" disabled>
                            <span>False</span>
                        </label>
                    </div>
                </div>
            `;
        } else if (questionType === 'fill_blank') {
            previewHtml += `
                <div class="mt-4">
                    <input type="text" placeholder="Enter your answer..." class="block w-full max-w-md px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" disabled>
                </div>
            `;
        } else if (questionType === 'essay') {
            const minWords = document.getElementById('min_words').value;
            const maxWords = document.getElementById('max_words').value;
            let wordRequirement = '';
            if (minWords || maxWords) {
                wordRequirement = ` (${minWords ? `Min: ${minWords}` : ''}${minWords && maxWords ? ', ' : ''}${maxWords ? `Max: ${maxWords}` : ''} words)`;
            }
            previewHtml += `
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Your Answer${wordRequirement}</label>
                    <textarea rows="6" placeholder="Enter your essay response..." class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" disabled></textarea>
                </div>
            `;
        }
        
        previewHtml += '</div>';
        
        document.getElementById('previewContent').innerHTML = previewHtml;
        document.getElementById('previewModal').classList.remove('hidden');
        } catch (error) {
            console.error('Error generating preview:', error);
            alert('Error generating preview. Please check your question data.');
        }
    }
    
    function getQuestionTypeLabel(type) {
        const labels = {
            'mcq': 'Multiple Choice',
            'multi_select': 'Multi-Select',
            'true_false': 'True/False',
            'fill_blank': 'Fill in the Blank',
            'essay': 'Essay'
        };
        return labels[type] || type;
    }
    
    window.closePreviewModal = function() {
        document.getElementById('previewModal').classList.add('hidden');
    };
    
    // Modal close on escape and click outside
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePreviewModal();
        }
    });
    
    document.getElementById('previewModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePreviewModal();
        }
    });
    
    // Image upload with drag and drop
    const imageInput = document.getElementById('image');
    const imageUploadArea = imageInput.closest('.border-dashed');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        imageUploadArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        imageUploadArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        imageUploadArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight(e) {
        imageUploadArea.classList.add('drag-over');
    }
    
    function unhighlight(e) {
        imageUploadArea.classList.remove('drag-over');
    }
    
    imageUploadArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            imageInput.files = files;
        }
    }
});
</script>
{% endblock %}